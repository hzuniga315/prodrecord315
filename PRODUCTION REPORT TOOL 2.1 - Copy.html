<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Reporting Tool - Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #C00000 0%, #900000 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .tabs {
            display: flex;
            background: #e0e0e0;
            border-bottom: 3px solid #C00000;
        }

        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            background: #9e9e9e;
            border: none;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            color: white;
        }

        .tab:hover {
            background: #757575;
        }

        .tab.active {
            background: white;
            color: #C00000;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 0.75em;
        }

        th {
            background: #C00000;
            color: white;
            padding: 8px 4px;
            text-align: left;
            font-weight: bold;
            font-size: 0.85em;
            white-space: nowrap;
        }

        td {
            padding: 6px 3px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: #f5f5f5;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 4px;
            border: 1px solid #9e9e9e;
            border-radius: 4px;
            font-size: 0.75em;
            text-transform: uppercase;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        input[type="text"]:focus, 
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #C00000;
            box-shadow: 0 0 5px rgba(192, 0, 0, 0.3);
        }

        input:disabled {
            background: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.6;
        }

        button {
            background: #C00000;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: bold;
            transition: all 0.3s;
            margin: 5px;
        }

        button:hover {
            background: #900000;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button.delete {
            background: #424242;
        }

        button.delete:hover {
            background: #212121;
        }

        button.export {
            background: #616161;
        }

        button.export:hover {
            background: #424242;
        }

        button.small {
            padding: 4px 8px;
            font-size: 0.75em;
        }

        button.settings-btn {
            background: #1565c0;
        }

        button.settings-btn:hover {
            background: #0d47a1;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #212121;
            font-size: 0.9em;
        }

        .search-box {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }

        .production-card {
            background: white;
            border: 2px solid #C00000;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .production-card h3 {
            color: #C00000;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #424242 0%, #212121 100%);
            color: white;
            padding: 18px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h4 {
            font-size: 0.85em;
            margin-bottom: 10px;
            opacity: 0.9;
            color: white;
        }

        .stat-card .value {
            font-size: 1.8em;
            font-weight: bold;
            color: white;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-size: 0.9em;
        }

        .alert.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .alert.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .alert.info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #90caf9;
        }

        .alert.warning {
            background: #fff3e0;
            color: #e65100;
            border: 1px solid #ffb74d;
        }

        .scrollable-table {
            max-height: 400px;
            overflow-y: auto;
        }

        .inline-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            align-items: end;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .compact-stat {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            margin: 5px 0;
            font-size: 0.9em;
        }

        .compact-stat strong {
            color: #212121;
        }

        .roll-entry-section {
            background: #fafafa;
            border: 2px solid #C00000;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .roll-entry-section h4 {
            color: #212121;
            margin-bottom: 15px;
            border-bottom: 2px solid #C00000;
            padding-bottom: 10px;
            font-size: 1.1em;
        }

        .roll-input-row {
            display: grid;
            grid-template-columns: 80px 150px 150px 100px;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .roll-input-row label {
            font-weight: bold;
            color: #424242;
            font-size: 0.9em;
        }

        .rolls-list {
            margin-top: 15px;
        }

        .roll-summary {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .unsaved-banner {
            background: #fff3e0;
            border: 2px solid #f57c00;
            border-radius: 5px;
            padding: 12px 20px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .unsaved-banner .warning-icon {
            font-size: 1.5em;
            margin-right: 10px;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #C00000;
        }

        .modal-header h2 {
            color: #C00000;
            font-size: 1.5em;
        }

        .modal-footer {
            margin-top: 25px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        @media (max-width: 768px) {
            .inline-form {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 0.7em;
            }
            
            th, td {
                padding: 5px 2px;
            }

            .roll-input-row {
                grid-template-columns: 1fr;
            }
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin: 5px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2e7d32, #4caf50);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
        }

        .progress-fill.partial {
            background: linear-gradient(90deg, #f57c00, #ff9800);
        }

        .progress-fill.not-started {
            background: linear-gradient(90deg, #616161, #9e9e9e);
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-badge.completed {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-badge.in-progress {
            background: #fff3e0;
            color: #e65100;
        }

        .status-badge.not-started {
            background: #ffebee;
            color: #c62828;
        }

        .dashboard-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .mini-stat {
            display: inline-block;
            margin: 5px 10px;
            padding: 8px 15px;
            background: #f5f5f5;
            border-radius: 5px;
            font-size: 0.85em;
        }

        .mini-stat strong {
            color: #212121;
        }

        h2 {
            color: #C00000;
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        h3 {
            color: #212121;
            font-size: 1.2em;
            margin: 15px 0 10px 0;
        }

        h4 {
            color: #424242;
            font-size: 1em;
            margin: 10px 0;
        }

        .label-actions {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        /* Enhanced Label Styles */
        .skid-label {
            width: 8.5in;
            height: 11in;
            margin: 0;
            padding: 0.4in;
            font-family: Arial, sans-serif;
            font-size: 12px;
            line-height: 1.2;
            background: white;
            color: black;
            page-break-after: always;
            box-sizing: border-box;
            position: relative;
        }

        .label-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 4px solid #C00000;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .label-header-left {
            flex: 1;
        }

        .label-company-name {
            font-size: 36px;
            font-weight: bold;
            color: #C00000;
            margin-bottom: 5px;
            font-family: Arial Black, Arial, sans-serif;
            letter-spacing: 2px;
        }

        .label-subtitle {
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .label-contact {
            font-size: 10px;
            color: #333;
        }

        .label-header-right {
            border: 3px solid #2e7d32;
            width: 180px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }

        .label-barcode-placeholder {
            text-align: center;
            color: #757575;
            font-size: 10px;
        }

        .label-info-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 15px 0;
        }

        .label-field {
            display: flex;
            align-items: baseline;
            font-size: 11px;
            border-bottom: 2px solid #000;
            padding-bottom: 3px;
        }

        .label-field-name {
            font-weight: bold;
            min-width: 85px;
            color: #424242;
        }

        .label-field-value {
            flex: 1;
            font-size: 12px;
            padding-left: 5px;
        }

        .label-wo-number {
            font-size: 72px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            font-family: Arial Black, Arial, sans-serif;
            color: #C00000;
            line-height: 1;
        }

        .label-description-box {
            border: 3px solid #000;
            padding: 15px;
            margin: 20px 0;
            background: #fafafa;
        }

        .label-description-title {
            font-weight: bold;
            font-size: 10px;
            color: #C00000;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .label-description-text {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            color: #000;
        }

        .label-weights-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .label-weight-box {
            border: 2px solid #000;
            padding: 12px;
            background: white;
        }

        .label-weight-label {
            font-size: 11px;
            font-weight: bold;
            color: #424242;
            margin-bottom: 5px;
        }

        .label-weight-value {
            font-size: 24px;
            font-weight: bold;
            color: #000;
        }

        .label-rolls-section {
            margin: 15px 0;
            border: 2px solid #C00000;
            padding: 12px;
            background: #fff;
            max-height: 200px;
            overflow-y: auto;
        }

        .label-rolls-title {
            font-weight: bold;
            font-size: 11px;
            color: #C00000;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .label-roll-item {
            padding: 4px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 10px;
        }

        .label-roll-item:last-child {
            border-bottom: none;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .print-content, .print-content * {
                visibility: visible;
            }
            .print-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            
            .skid-label {
                width: 8.5in;
                height: 11in;
                margin: 0 !important;
                padding: 0.4in !important;
                box-sizing: border-box;
            }
            
            @page {
                size: 8.5in 11in portrait;
                margin: 0;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* Settings specific styles */
        .settings-section {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            border: 2px solid #e0e0e0;
        }

        .settings-section h3 {
            color: #1565c0;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            font-size: 0.9em;
        }

        /* Edit Skid Modal Styles */
        .edit-skid-modal {
            background: white;
            border-radius: 8px;
            padding: 25px;
            max-width: 700px;
            width: 90%;
        }

        .edit-skid-modal h3 {
            color: #C00000;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #C00000;
        }

        .edit-form-section {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .edit-form-section h4 {
            color: #424242;
            margin-bottom: 15px;
            font-size: 0.95em;
        }

        .edit-roll-row {
            display: grid;
            grid-template-columns: 60px 1fr 1fr 80px;
            gap: 10px;
            align-items: center;
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin: 8px 0;
            border: 1px solid #e0e0e0;
        }

        .edit-roll-row label {
            font-weight: bold;
            color: #212121;
            font-size: 0.85em;
        }

        .edit-roll-row input {
            padding: 6px;
            border: 1px solid #9e9e9e;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .skid-card {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #2e7d32;
            position: relative;
        }

        .skid-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .skid-actions {
            display: flex;
            gap: 5px;
        }

        .btn-edit {
            background: #1565c0;
            padding: 6px 12px;
            font-size: 0.8em;
        }

        .btn-edit:hover {
            background: #0d47a1;
        }

        .btn-delete-skid {
            background: #c62828;
            padding: 6px 12px;
            font-size: 0.8em;
        }

        .btn-delete-skid:hover {
            background: #b71c1c;
        }

        /* Settings Status Indicator */
        .settings-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #e8f5e9;
            padding: 10px 15px;
            border-radius: 5px;
            border: 2px solid #2e7d32;
            font-size: 0.85em;
            z-index: 999;
            display: none;
        }

        .settings-status.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        /* Sortable Table Styles */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px !important;
        }

        .sortable-header:hover {
            background: #a00000 !important;
        }

        .sort-indicator {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7em;
            opacity: 0.5;
        }

        .sort-indicator.active {
            opacity: 1;
            font-weight: bold;
        }

        .sort-controls {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border: 2px solid #e0e0e0;
        }

        .sort-controls h4 {
            color: #212121;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .sort-button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .sort-btn {
            padding: 8px 16px;
            font-size: 0.85em;
            background: white;
            border: 2px solid #9e9e9e;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sort-btn:hover {
            background: #e0e0e0;
            border-color: #757575;
        }

        .sort-btn.active {
            background: #C00000;
            color: white;
            border-color: #C00000;
        }

        .timezone-badge {
            display: inline-block;
            background: #2e7d32;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-left: 10px;
            font-weight: bold;
        }

        .operator-badge {
            display: inline-block;
            background: #1565c0;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <!-- Settings Status Indicator -->
    <div id="settingsStatus" class="settings-status"></div>

    <div class="container">
        <header>
            <h1>Production Reporting Tool <span class="timezone-badge">EST</span></h1>
            <p class="subtitle">GRIMCO Manufacturing - HIPS Extrusion Operations</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('supervisor')">Supervisor</button>
            <button class="tab" onclick="switchTab('operator')">Operator</button>
            <button class="tab" onclick="switchTab('qc')">Quality Control</button>
            <button class="tab" onclick="switchTab('dashboard')">Progress Dashboard</button>
            <button class="tab settings-btn" onclick="openSettingsModal()">‚öôÔ∏è Settings</button>
        </div>

        <!-- PROGRESS DASHBOARD (Visible summary on all tabs) -->
        <div id="progressSummary" style="background: #fafafa; padding: 15px; border-bottom: 2px solid #C00000;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0; color: #212121;">Production Overview</h3>
                <button onclick="refreshDashboard()" style="padding: 8px 16px;">Refresh</button>
            </div>
            <div id="dashboardSummary"></div>
        </div>

        <!-- SUPERVISOR SECTION -->
        <div id="supervisor" class="tab-content active">
            <h2>Work Order Management</h2>
            
            <div class="btn-group">
                <button onclick="addWorkOrder()">+ Add New Work Order</button>
                <button class="export" onclick="exportAllData()">Export All Data to CSV</button>
		<button class="export" onclick="exportSimplifiedProductionReport()" style="background: #2e7d32;">üìä Export Simplified Report</button>
		<button class="export" onclick="clearAllData()" style="background: #c62828;">‚ö†Ô∏è Clear All Data</button>
            </div>

            <div class="alert info" style="margin-bottom: 20px;">
                <strong>üí° Quick Entry Tip:</strong> You can copy multiple rows from Excel/Google Sheets and paste directly into the table below. 
                Click any cell, then press <kbd style="background: #e0e0e0; padding: 2px 6px; border-radius: 3px; font-family: monospace;">Ctrl+V</kbd> (or <kbd style="background: #e0e0e0; padding: 2px 6px; border-radius: 3px; font-family: monospace;">Cmd+V</kbd> on Mac) to paste.
            </div>

            <div class="scrollable-table">
                <table id="workOrderTable">
                    <thead>
                        <tr>
                            <th>Order Date</th>
                            <th>Due Date</th>
                            <th>Work Order #</th>
                            <th>Line Number</th>
                            <th>Item Number</th>
                            <th>Customer Name</th>
                            <th>Customer PO</th>
                            <th>Product Type</th>
                            <th>Color</th>
                            <th>Material</th>
                            <th>Length</th>
                            <th>Width</th>
                            <th>Gauge</th>
                            <th>Finish</th>
                            <th>Skids Requested</th>
                            <th>Total Pounds Requested</th>
                            <th>Sheets Requested</th>
                            <th>Rolls Requested</th>
                            <th>Special Instructions</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="workOrderBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- OPERATOR SECTION -->
        <div id="operator" class="tab-content">
            <h2>Production Management</h2>

            <div class="search-box">
                <h3>Search Work Order</h3>
                <div class="inline-form">
                    <div class="form-group">
                        <label>Work Order #</label>
                        <input type="text" id="searchWorkOrder" placeholder="Enter Work Order Number" onkeypress="handleWorkOrderKeyPress(event)">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button onclick="searchWorkOrder()">Search & Start Production</button>
                    </div>
                </div>
            </div>

            <div class="tabs" style="margin-top: 20px;">
                <button class="tab active" onclick="switchOperatorTab('skids')">Skid Production</button>
                <button class="tab" onclick="switchOperatorTab('downtime')">Downtime</button>
            </div>

            <div id="operatorSkids" class="tab-content active" style="display: block;">
                <div id="productionArea"></div>
            </div>

            <div id="operatorDowntime" class="tab-content">
                <div id="downtimeArea"></div>
            </div>
        </div>

        <!-- QC SECTION -->
<div id="qc" class="tab-content">
    <h2>Scrap Recording</h2>

    <div class="search-box">
        <h3>Select Work Order</h3>
        <div class="inline-form">
            <div class="form-group">
                <label>Work Order #</label>
                <input type="text" id="qcWorkOrderInput" placeholder="Enter Work Order Number" onkeypress="handleQCKeyPress(event)">
            </div>
            <div class="form-group">
                <label>&nbsp;</label>
                <button onclick="selectQCWorkOrder()">Select Work Order</button>
            </div>
        </div>
        <p style="color: #2e7d32; font-size: 0.85em; margin-top: 10px;">
            <strong>Note:</strong> Scrap can be recorded for any work order, including completed ones.
        </p>
    </div>

    <div id="qcWorkOrderInfo" style="display: none; background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #1565c0;">
        <h4 style="color: #1565c0; margin-bottom: 10px;">Selected Work Order</h4>
        <div id="qcWorkOrderDetails"></div>
        <button onclick="clearQCWorkOrderSelection()" style="margin-top: 10px; background: #757575; font-size: 0.85em; padding: 8px 16px;">Clear Selection</button>
    </div>

    <div class="production-card">
        <h3>Record Scrap</h3>
        <div id="scrapEntryAlert" class="alert warning" style="display: none; margin-bottom: 15px;">
            <strong>‚ö†Ô∏è No Work Order Selected:</strong> Please select a work order above before recording scrap.
        </div>
        <div class="inline-form">
            <div class="form-group">
                <label>Scrap Type</label>
                <input type="text" id="scrapType" placeholder="e.g., Edge Trim, Defect">
            </div>
            <div class="form-group">
                <label>Scrap Weight (lbs)</label>
                <input type="number" id="scrapWeight" step="0.01" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>Reason</label>
                <input type="text" id="scrapReason" placeholder="Description">
            </div>
            <div class="form-group">
                <label>&nbsp;</label>
                <button onclick="recordScrap()">Add Scrap Record</button>
            </div>
        </div>
    </div>

    <div class="scrollable-table">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0;">Scrap History</h3>
            <div id="scrapFilterStatus" style="font-size: 0.85em; color: #757575;"></div>
        </div>
        <table id="scrapTable">
            <thead>
                <tr>
                    <th>Timestamp (EST)</th>
                    <th>Work Order #</th>
                    <th>Scrap Type</th>
                    <th>Weight (lbs)</th>
                    <th>Reason</th>
                    <th>Operator</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="scrapBody">
            </tbody>
        </table>
    </div>
</div>

        <!-- PROGRESS DASHBOARD TAB -->
        <div id="dashboard" class="tab-content">
            <h2>Production Progress Dashboard</h2>
            
            <div class="alert info" style="margin-bottom: 20px;">
                <strong>üìä Dashboard Overview:</strong> View comprehensive production metrics, shift breakdowns, and work order progress. <span class="timezone-badge">All times shown in EST</span>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
                <button id="showDashboardBtn" onclick="buildFullDashboard()" style="font-size: 1.1em; padding: 15px 40px; background: #2e7d32;">
                    üìà Show Full Dashboard
                </button>
                <button id="hideDashboardBtn" onclick="hideFullDashboard()" style="font-size: 1.1em; padding: 15px 40px; background: #c62828; display: none;">
                    ‚úñÔ∏è Hide Full Dashboard
                </button>
            </div>
            
            <div id="fullDashboard" style="display: none;"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è System Settings</h2>
            </div>

            <div class="alert info" style="margin-bottom: 20px;">
                <strong>üí° Settings Info:</strong> Changes will be saved to your browser and used for all future label printing. Settings are specific to this browser/computer.
            </div>

            <div class="settings-section">
                <h3>Label Configuration</h3>
                
                <div class="form-group">
                    <label>Company Name</label>
                    <input type="text" id="settingCompanyName" placeholder="GRIMCO MANUFACTURING">
                </div>

                <div class="form-group">
                    <label>Operations Subtitle</label>
                    <input type="text" id="settingSubtitle" placeholder="HIPS EXTRUSION OPERATIONS">
                </div>

                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="text" id="settingPhone" placeholder="(555) 123-4567">
                </div>

                <div class="form-group">
                    <label>Email Address</label>
                    <input type="text" id="settingEmail" placeholder="production@grimco.com">
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="settingShowBarcode">
                    <label for="settingShowBarcode">Show barcode box on labels</label>
                </div>
            </div>

            <div class="settings-section">
                <h3>Display Preferences</h3>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="settingShowRollDetails">
                    <label for="settingShowRollDetails">Show detailed roll information on labels</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="settingAutoSave" checked>
                    <label for="settingAutoSave">Enable auto-save (every 30 seconds)</label>
                </div>
            </div>

            <div class="modal-footer">
                <button onclick="closeSettingsModal()" style="background: #757575;">Cancel</button>
                <button onclick="saveSettings()">üíæ Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Edit Skid Modal -->
    <div id="editSkidModal" class="modal-overlay">
        <div class="modal-content edit-skid-modal">
            <div class="modal-header">
                <h3>‚úèÔ∏è Edit Skid Entry</h3>
            </div>

            <div id="editSkidContent">
                <!-- Content will be populated dynamically -->
            </div>

            <div class="modal-footer">
                <button onclick="closeEditSkidModal()" style="background: #757575;">Cancel</button>
                <button onclick="saveSkidEdits()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== DATA STORAGE WITH FIXED SETTINGS PERSISTENCE ====================
        let workOrders = JSON.parse(localStorage.getItem('workOrders')) || [];
        let productionData = JSON.parse(localStorage.getItem('productionData')) || [];
        let scrapData = JSON.parse(localStorage.getItem('scrapData')) || [];
        let downtimeData = JSON.parse(localStorage.getItem('downtimeData')) || [];
        let tempRolls = JSON.parse(localStorage.getItem('tempRolls')) || {};
        
        // FIXED: Default settings
        const defaultSettings = {
            companyName: 'GRIMCO MANUFACTURING',
            subtitle: 'HIPS EXTRUSION OPERATIONS',
            phone: '(555) 123-4567',
            email: 'production@grimco.com',
            showBarcode: true,
            showRollDetails: true,
            autoSave: true
        };
        
        // FIXED: Function to properly load settings from localStorage
        function loadSystemSettings() {
            const stored = localStorage.getItem('systemSettings');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    // Merge with defaults to ensure all properties exist
                    console.log('‚úÖ Loaded settings from localStorage:', parsed);
                    return { ...defaultSettings, ...parsed };
                } catch (e) {
                    console.error('‚ùå Error loading settings:', e);
                    return { ...defaultSettings };
                }
            }
            console.log('‚ÑπÔ∏è No saved settings found, using defaults');
            return { ...defaultSettings };
        }
        
        // FIXED: Initialize settings properly
        let systemSettings = loadSystemSettings();
        
        let selectedQCWorkOrder = '';
        let editingSkid = null;
        
        // Sorting state
        let currentSortColumn = 'workOrder';
        let currentSortDirection = 'asc';

        // ==================== TIMEZONE HELPER FUNCTION (EST) ====================
        function getESTTimestamp() {
            return new Date().toLocaleString('en-US', { 
                timeZone: 'America/New_York',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
        }

        // ==================== FIXED: ROBUST TIMESTAMP PARSING ====================
        function parseTimestampToEST(timestamp) {
            // Handle both UTC (ISO) and EST formats
            let date;
            
            // Check if it's UTC/ISO format (e.g., "2025-01-15T14:30:00Z")
            if (timestamp.includes('T') && (timestamp.includes('Z') || timestamp.includes('+'))) {
                date = new Date(timestamp);
            }
            // Check if it's EST format (e.g., "01/15/2025, 02:30:00 PM")
            else if (timestamp.includes(',')) {
                // Already in EST format, create date from it
                const [datePart, timePart] = timestamp.split(',').map(s => s.trim());
                const [month, day, year] = datePart.split('/').map(Number);
                const [time, period] = timePart.split(' ');
                const [hours, minutes, seconds] = time.split(':').map(Number);
                
                let hour24 = hours;
                if (period === 'PM' && hours !== 12) hour24 = hours + 12;
                if (period === 'AM' && hours === 12) hour24 = 0;
                
                // Create date in EST timezone
                date = new Date(year, month - 1, day, hour24, minutes, seconds);
            }
            // Fallback: try to parse as-is
            else {
                date = new Date(timestamp);
            }
            
            // Convert to EST string format
            return date.toLocaleString('en-US', { 
                timeZone: 'America/New_York',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
        }

        // ==================== FIXED: SHIFT INFO EXTRACTION ====================
        function getShiftInfo(timestamp) {
            // First, normalize the timestamp to EST format
            const estTimestamp = parseTimestampToEST(timestamp);
            
            // Parse EST timestamp format: "MM/DD/YYYY, HH:MM:SS AM/PM"
            const datePart = estTimestamp.split(',')[0]; // MM/DD/YYYY
            const timePart = estTimestamp.split(',')[1].trim(); // HH:MM:SS AM/PM
            
            const [month, day, year] = datePart.split('/').map(Number);
            const hour24Part = timePart.split(':')[0];
            const isPM = timePart.includes('PM');
            
            let hour = parseInt(hour24Part);
            if (isPM && hour !== 12) hour += 12;
            if (!isPM && hour === 12) hour = 0;
            
            let productionDay;
            let shift;
            
            // 1st Shift: 6 AM to 6 PM
            if (hour >= 6 && hour < 18) {
                shift = 1;
                productionDay = new Date(year, month - 1, day);
            }
            // 2nd Shift starting at 6 PM on same day
            else if (hour >= 18) {
                shift = 2;
                productionDay = new Date(year, month - 1, day);
            }
            // 2nd Shift continuing past midnight (before 6 AM)
            else {
                shift = 2;
                productionDay = new Date(year, month - 1, day - 1);
            }
            
            const dateKey = productionDay.toISOString().split('T')[0];
            return { dateKey, shift };
        }

        // ==================== SETTINGS FUNCTIONS (FIXED) ====================
        function openSettingsModal() {
            // FIXED: Reload settings from localStorage to ensure we have the latest
            systemSettings = loadSystemSettings();
            
            // Populate form with current settings
            document.getElementById('settingCompanyName').value = systemSettings.companyName;
            document.getElementById('settingSubtitle').value = systemSettings.subtitle;
            document.getElementById('settingPhone').value = systemSettings.phone;
            document.getElementById('settingEmail').value = systemSettings.email;
            document.getElementById('settingShowBarcode').checked = systemSettings.showBarcode;
            document.getElementById('settingShowRollDetails').checked = systemSettings.showRollDetails;
            document.getElementById('settingAutoSave').checked = systemSettings.autoSave;
            
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function saveSettings() {
            // Get values from form
            systemSettings.companyName = document.getElementById('settingCompanyName').value.toUpperCase();
            systemSettings.subtitle = document.getElementById('settingSubtitle').value.toUpperCase();
            systemSettings.phone = document.getElementById('settingPhone').value;
            systemSettings.email = document.getElementById('settingEmail').value.toLowerCase();
            systemSettings.showBarcode = document.getElementById('settingShowBarcode').checked;
            systemSettings.showRollDetails = document.getElementById('settingShowRollDetails').checked;
            systemSettings.autoSave = document.getElementById('settingAutoSave').checked;
            
            // FIXED: Save to localStorage
            localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
            
            console.log('üíæ Settings saved:', systemSettings);
            
            // Show confirmation with current settings
            showSettingsConfirmation();
            closeSettingsModal();
        }

        // FIXED: New function to show detailed confirmation
        function showSettingsConfirmation() {
            const statusDiv = document.getElementById('settingsStatus');
            statusDiv.innerHTML = `
                <strong>‚úÖ Settings Saved!</strong><br>
                <small>Company: ${systemSettings.companyName}<br>
                Subtitle: ${systemSettings.subtitle}</small>
            `;
            statusDiv.classList.add('show');
            
            setTimeout(() => {
                statusDiv.classList.remove('show');
            }, 4000);
        }

        // ==================== EDIT SKID FUNCTIONS ====================
        function openEditSkidModal(woNumber, skidIndex) {
            const production = productionData.find(p => p.workOrder === woNumber);
            const order = workOrders.find(o => o.workOrder === woNumber);
            
            if (!production || !order) {
                alert('Production or work order not found');
                return;
            }
            
            const skid = production.skids[skidIndex];
            if (!skid) {
                alert('Skid not found');
                return;
            }
            
            editingSkid = {
                woNumber: woNumber,
                skidIndex: skidIndex,
                isRolls: order.productType === 'Rolls',
                isSheets: order.productType === 'Sheets'
            };
            
            const skidNum = skidIndex + 1;
            const isRolls = order.productType === 'Rolls';
            const isSheets = order.productType === 'Sheets';
            
            let content = `
                <div class="alert info" style="margin-bottom: 15px;">
                    <strong>Editing:</strong> ${woNumber} - Skid #${skidNum}
                </div>
                
                <div class="edit-form-section">
                    <h4>Skid Information</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Operator Name</label>
                            <input type="text" id="editOperator" value="${skid.operator || ''}" placeholder="Operator Name">
                        </div>
                    </div>
                </div>
                
                <div class="edit-form-section">
                    <h4>Skid Weights</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Gross Weight (lbs)</label>
                            <input type="number" id="editGrossWeight" step="0.01" value="${skid.grossWeight}">
                        </div>
                        <div class="form-group">
                            <label>Net Weight (lbs)</label>
                            <input type="number" id="editNetWeight" step="0.01" value="${skid.netWeight}">
                        </div>
                    </div>
                </div>
            `;
            
            if (isRolls && skid.rolls && skid.rolls.length > 0) {
                content += `
                    <div class="edit-form-section">
                        <h4>Rolls in This Skid (${skid.rolls.length})</h4>
                        <div id="editRollsList">
                `;
                
                skid.rolls.forEach((roll, idx) => {
                    content += `
                        <div class="edit-roll-row">
                            <label>Roll ${idx + 1}:</label>
                            <div>
                                <label style="font-size: 0.75em; font-weight: normal; display: block; margin-bottom: 3px;">Weight (lbs)</label>
                                <input type="number" id="editRollWeight_${idx}" step="0.01" value="${roll.weight}">
                            </div>
                            <div>
                                <label style="font-size: 0.75em; font-weight: normal; display: block; margin-bottom: 3px;">Length (ft)</label>
                                <input type="number" id="editRollLength_${idx}" step="1" value="${roll.length || ''}">
                            </div>
                            <button class="delete small" onclick="deleteRollFromSkid(${idx})" style="height: fit-content;">Delete</button>
                        </div>
                    `;
                });
                
                content += `
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 5px;">
                            <h4 style="color: #1565c0; margin-bottom: 10px;">Add New Roll to Skid</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 100px; gap: 10px; align-items: end;">
                                <div class="form-group">
                                    <label>Weight (lbs)</label>
                                    <input type="number" id="newRollWeight" step="0.01" placeholder="0.00">
                                </div>
                                <div class="form-group">
                                    <label>Length (ft) - Optional</label>
                                    <input type="number" id="newRollLength" step="1" placeholder="0">
                                </div>
                                <button onclick="addRollToEditingSkid()" style="background: #2e7d32;">+ Add Roll</button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (isSheets) {
                content += `
                    <div class="edit-form-section">
                        <h4>Sheet Count</h4>
                        <div class="form-group">
                            <label>Number of Sheets</label>
                            <input type="number" id="editSheetCount" value="${skid.sheetCount || 0}">
                        </div>
                    </div>
                `;
            }
            
            content += `
                <div class="alert warning" style="margin-top: 15px;">
                    <strong>‚ö†Ô∏è Note:</strong> Changes will be saved immediately and cannot be undone. Please verify all entries before saving.
                </div>
            `;
            
            document.getElementById('editSkidContent').innerHTML = content;
            document.getElementById('editSkidModal').classList.add('active');
        }

        function closeEditSkidModal() {
            document.getElementById('editSkidModal').classList.remove('active');
            editingSkid = null;
        }

        function addRollToEditingSkid() {
            const weight = parseFloat(document.getElementById('newRollWeight').value);
            const length = document.getElementById('newRollLength').value ? parseFloat(document.getElementById('newRollLength').value) : null;
            
            if (!validatePositiveNumber(weight, 'Roll weight')) {
                return;
            }
            
            if (length !== null && length <= 0) {
                alert('Length must be greater than 0 if provided');
                return;
            }
            
            if (!editingSkid) return;
            
            const production = productionData.find(p => p.workOrder === editingSkid.woNumber);
            const skid = production.skids[editingSkid.skidIndex];
            
            if (!skid.rolls) {
                skid.rolls = [];
            }
            
            skid.rolls.push({
                weight: weight,
                length: length
            });
            
            openEditSkidModal(editingSkid.woNumber, editingSkid.skidIndex);
        }

        function deleteRollFromSkid(rollIndex) {
            if (!confirm('Delete this roll from the skid?')) return;
            
            if (!editingSkid) return;
            
            const production = productionData.find(p => p.workOrder === editingSkid.woNumber);
            const skid = production.skids[editingSkid.skidIndex];
            
            skid.rolls.splice(rollIndex, 1);
            
            openEditSkidModal(editingSkid.woNumber, editingSkid.skidIndex);
        }

        function saveSkidEdits() {
            if (!editingSkid) {
                alert('No skid is being edited');
                return;
            }
            
            const production = productionData.find(p => p.workOrder === editingSkid.woNumber);
            const skid = production.skids[editingSkid.skidIndex];
            
            const newGross = parseFloat(document.getElementById('editGrossWeight').value);
            const newNet = parseFloat(document.getElementById('editNetWeight').value);
            const newOperator = document.getElementById('editOperator').value.trim().toUpperCase();
            
            if (!validateWeight(newGross, newNet, 'Skid weight')) {
                return;
            }
            
            skid.grossWeight = newGross;
            skid.netWeight = newNet;
            skid.operator = newOperator;
            
            if (editingSkid.isRolls && skid.rolls) {
                skid.rolls.forEach((roll, idx) => {
                    const weightInput = document.getElementById(`editRollWeight_${idx}`);
                    const lengthInput = document.getElementById(`editRollLength_${idx}`);
                    
                    if (weightInput) {
                        const weight = parseFloat(weightInput.value);
                        if (!validatePositiveNumber(weight, `Roll ${idx + 1} weight`)) {
                            return;
                        }
                        roll.weight = weight;
                    }
                    
                    if (lengthInput) {
                        const length = lengthInput.value ? parseFloat(lengthInput.value) : null;
                        if (length !== null && length <= 0) {
                            alert(`Roll ${idx + 1}: Length must be greater than 0 if provided`);
                            return;
                        }
                        roll.length = length;
                    }
                });
            }
            
            if (editingSkid.isSheets) {
                const newSheetCount = parseInt(document.getElementById('editSheetCount').value);
                if (!validatePositiveNumber(newSheetCount, 'Sheet count')) {
                    return;
                }
                skid.sheetCount = newSheetCount;
            }
            
            skid.lastEdited = getESTTimestamp();
            
            localStorage.setItem('productionData', JSON.stringify(productionData));
            
            closeEditSkidModal();
            
            displayProduction(production);
            refreshDashboard();
            
            const alert = document.createElement('div');
            alert.className = 'alert success';
            alert.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; animation: slideIn 0.3s ease;';
            alert.innerHTML = `
                <strong>‚úì Skid Updated!</strong><br>
                Changes saved successfully.
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }

        function deleteSkid(woNumber, skidIndex) {
            if (!confirm('‚ö†Ô∏è WARNING: Delete this entire skid?\n\nThis will permanently remove all data for this skid including rolls/sheets. This cannot be undone.')) {
                return;
            }
            
            const production = productionData.find(p => p.workOrder === woNumber);
            if (!production) return;
            
            production.skids.splice(skidIndex, 1);
            
            localStorage.setItem('productionData', JSON.stringify(productionData));
            
            displayProduction(production);
            refreshDashboard();
            
            const alert = document.createElement('div');
            alert.className = 'alert success';
            alert.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; animation: slideIn 0.3s ease;';
            alert.innerHTML = `
                <strong>‚úì Skid Deleted</strong><br>
                Skid removed from production records.
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }

        function saveTempRolls() {
            localStorage.setItem('tempRolls', JSON.stringify(tempRolls));
        }

        // ==================== VALIDATION FUNCTIONS ====================
        function validateWeight(gross, net, fieldName = 'Weight') {
            if (isNaN(gross) || gross <= 0) {
                alert(`${fieldName}: Gross weight must be a positive number`);
                return false;
            }
            
            if (isNaN(net) || net <= 0) {
                alert(`${fieldName}: Net weight must be a positive number`);
                return false;
            }
            
            if (net > gross) {
                alert(`${fieldName}: Net weight (${net} lbs) cannot exceed gross weight (${gross} lbs)`);
                return false;
            }
            
            return true;
        }

        function validatePositiveNumber(value, fieldName) {
            if (isNaN(value) || value <= 0) {
                alert(`${fieldName} must be a positive number`);
                return false;
            }
            return true;
        }

        // ==================== INITIALIZATION (FIXED) ====================
        window.onload = function() {
            // FIXED: Reload settings at startup to ensure persistence
            systemSettings = loadSystemSettings();
            console.log('üöÄ Application initialized with settings:', systemSettings);
            
            loadWorkOrders();
            loadScrapHistory();
            refreshDashboard();
            checkUnsavedRolls();
            
            // Auto-save if enabled
            if (systemSettings.autoSave) {
                setInterval(autoSave, 30000);
            }
            
            window.addEventListener('beforeunload', function(e) {
                if (hasUnsavedRolls()) {
                    e.preventDefault();
                    e.returnValue = 'You have unsaved roll data. Are you sure you want to leave?';
                    return e.returnValue;
                }
            });
            
            document.addEventListener('input', function(e) {
                if (e.target.tagName === 'INPUT' && e.target.type === 'text') {
                    e.target.value = e.target.value.toUpperCase();
                }
            });
            
            setupWorkOrderPasteHandler();
        };


// ==================== AUTO DATE CHANGE DETECTION ====================
	let lastCheckedDate = new Date().toDateString();

	function checkDateChange() {
	    const currentDate = new Date().toDateString();
    
	    if (currentDate !== lastCheckedDate) {
	        console.log('üìÖ Date changed detected! Refreshing dashboard...');
	        lastCheckedDate = currentDate;
        
	        // Refresh the dashboard if it's currently visible
	        const dashboardTab = document.getElementById('dashboard');
	        if (dashboardTab && dashboardTab.classList.contains('active')) {
	            const fullDashboard = document.getElementById('fullDashboard');
	            if (fullDashboard && fullDashboard.style.display !== 'none') {
	                buildFullDashboard();
	            }
	        }
        
	        // Always refresh the summary at the top
	        refreshDashboard();
        
	        // Show notification
	        showDateChangeNotification();
	    }
	}

	function showDateChangeNotification() {
	    const alert = document.createElement('div');
	    alert.className = 'alert success';
	    alert.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; animation: slideIn 0.3s ease;';
	    alert.innerHTML = `
	        <strong>üìÖ New Day Started!</strong><br>
	        Dashboard automatically refreshed for ${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
	    `;
    
	    document.body.appendChild(alert);
    
	    setTimeout(() => {
	        alert.style.animation = 'slideOut 0.3s ease';
	        setTimeout(() => alert.remove(), 300);
	    }, 5000);
	}

	// Check for date change every minute
	setInterval(checkDateChange, 60000); // 60000 ms = 1 minute

	// Also check when page regains focus (user switches back to tab)
	document.addEventListener('visibilitychange', function() {
	    if (!document.hidden) {
	        checkDateChange();
	    }
	  });
	
	   window.addEventListener('focus', function() {
	   checkDateChange();
	});

       //AUTOMATIC REFRESH DONE

        function autoSave() {
            saveWorkOrders();
            saveTempRolls();
            console.log('üíæ Auto-saved at ' + getESTTimestamp());
        }

        function hasUnsavedRolls() {
            for (let skidNum in tempRolls) {
                if (tempRolls[skidNum] && tempRolls[skidNum].length > 0) {
                    return true;
                }
            }
            return false;
        }

        function checkUnsavedRolls() {
        }

        function showUnsavedBanner(skidNum) {
            const rollCount = tempRolls[skidNum] ? tempRolls[skidNum].length : 0;
            if (rollCount === 0) return '';
            
            return `
                <div class="unsaved-banner">
                    <div style="display: flex; align-items: center;">
                        <span class="warning-icon">‚ö†Ô∏è</span>
                        <div>
                            <strong>Unsaved Roll Data!</strong><br>
                            <span style="font-size: 0.9em;">You have ${rollCount} unsaved roll${rollCount > 1 ? 's' : ''} for Skid #${skidNum}. Click "Save Skid" to preserve this data.</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ==================== PASTE HANDLER ====================
        function setupWorkOrderPasteHandler() {
            const workOrderTable = document.getElementById('workOrderTable');
            
            workOrderTable.addEventListener('paste', function(e) {
                const target = e.target;
                
                if (target.tagName !== 'INPUT' && target.tagName !== 'SELECT') return;
                
                const row = target.closest('tr');
                if (!row) return;
                
                const clipboardData = e.clipboardData || window.clipboardData;
                const pastedData = clipboardData.getData('text');
                
                if (!pastedData) return;
                
                if (!pastedData.includes('\t') && !pastedData.includes('\n')) {
                    return;
                }
                
                e.preventDefault();
                
                const rows = pastedData.split('\n').filter(r => r.trim());
                const tbody = document.getElementById('workOrderBody');
                const currentRowIndex = Array.from(tbody.rows).indexOf(row);
                
                const currentCellIndex = getCellIndex(target);
                
                rows.forEach((rowData, rowOffset) => {
                    const cells = rowData.split('\t');
                    const targetRowIndex = currentRowIndex + rowOffset;
                    let targetRow = tbody.rows[targetRowIndex];
                    
                    if (!targetRow) {
                        addWorkOrder();
                        targetRow = tbody.rows[0];
                    }
                    
                    cells.forEach((cellValue, cellOffset) => {
                        const targetCellIndex = currentCellIndex + cellOffset;
                        fillWorkOrderCell(targetRow, targetCellIndex, cellValue.trim());
                    });
                });
                
                saveWorkOrders();
                showPasteConfirmation(rows.length);
            });
        }
        
        function getCellIndex(element) {
            const row = element.closest('tr');
            const cell = element.closest('td');
            if (!row || !cell) return 0;
            
            return Array.from(row.cells).indexOf(cell);
        }
        
        function fillWorkOrderCell(row, cellIndex, value) {
            if (cellIndex < 0 || cellIndex >= row.cells.length - 1) return;
            
            const cell = row.cells[cellIndex];
            const input = cell.querySelector('input, select');
            
            if (!input) return;
            
            if (input.tagName === 'SELECT') {
                const option = Array.from(input.options).find(opt => 
                    opt.value.toLowerCase() === value.toLowerCase() || 
                    opt.text.toLowerCase() === value.toLowerCase()
                );
                if (option) {
                    input.value = option.value;
                    
                    if (input.onchange) {
                        input.onchange();
                    }
                }
            } else if (input.type === 'date') {
                if (value) {
                    const date = parseDateString(value);
                    if (date) {
                        input.value = date;
                    }
                }
            } else {
                input.value = value;
                
                if (input.type === 'text') {
                    input.value = input.value.toUpperCase();
                }
            }
        }
        
        function parseDateString(dateStr) {
            if (!dateStr) return '';
            
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            
            let date;
            
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                const [month, day, year] = dateStr.split('/');
                date = new Date(year, month - 1, day);
            }
            else if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(dateStr)) {
                const [day, month, year] = dateStr.split('-');
                date = new Date(year, month - 1, day);
            }
            else if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(dateStr)) {
                const [year, month, day] = dateStr.split('/');
                date = new Date(year, month - 1, day);
            }
            else {
                date = new Date(dateStr);
            }
            
            if (date && !isNaN(date.getTime())) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            return '';
        }
        
        function showPasteConfirmation(rowCount) {
            const existingAlert = document.querySelector('.paste-alert');
            if (existingAlert) existingAlert.remove();
            
            const alert = document.createElement('div');
            alert.className = 'alert success paste-alert';
            alert.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; animation: slideIn 0.3s ease;';
            alert.innerHTML = `
                <strong>‚úì Paste Successful!</strong><br>
                ${rowCount} row${rowCount > 1 ? 's' : ''} imported from clipboard.
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }

        function handleWorkOrderKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                searchWorkOrder();
            }
        }

        function handleQCKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                selectQCWorkOrder();
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'qc') {
                loadScrapHistory();
            }
            
            refreshDashboard();
        }

        function switchOperatorTab(tabName) {
            const operatorTabs = document.querySelectorAll('#operator .tabs .tab');
            const operatorContents = document.querySelectorAll('#operatorSkids, #operatorDowntime');
            
            operatorTabs.forEach(t => t.classList.remove('active'));
            operatorContents.forEach(c => {
                c.classList.remove('active');
                c.style.display = 'none';
            });
            
            event.target.classList.add('active');
            const targetContent = document.getElementById('operator' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            targetContent.classList.add('active');
            targetContent.style.display = 'block';
        }

        function handleProductTypeChange(selectElement, rowIndex) {
            const row = selectElement.closest('tr');
            const sheetsInput = row.querySelector(`#sheets${rowIndex}`);
            const rollsInput = row.querySelector(`#rolls${rowIndex}`);
            const productType = selectElement.value;
            
            if (productType === 'Sheets') {
                sheetsInput.disabled = false;
                rollsInput.disabled = true;
                rollsInput.value = '';
            } else if (productType === 'Rolls') {
                rollsInput.disabled = false;
                sheetsInput.disabled = true;
                sheetsInput.value = '';
            } else {
                sheetsInput.disabled = true;
                rollsInput.disabled = true;
                sheetsInput.value = '';
                rollsInput.value = '';
            }
            
            saveWorkOrders();
        }

        // ==================== SUPERVISOR FUNCTIONS ====================
        function addWorkOrder() {
            const tbody = document.getElementById('workOrderBody');
            const row = tbody.insertRow(0);
            const today = new Date().toISOString().split('T')[0];
            const rowIndex = Date.now();
            
            row.innerHTML = `
                <td><input type="date" value="${today}" onchange="saveWorkOrders()"></td>
                <td><input type="date" onchange="saveWorkOrders()"></td>
                <td><input type="text" placeholder="WO-" maxlength="6" onchange="saveWorkOrders()"></td>
                <td>
                    <select onchange="saveWorkOrders()">
                        <option value="">-- Select --</option>
                        <option value="Line 2">Line 2</option>
                        <option value="Line 3">Line 3</option>
                        <option value="Line 4">Line 4</option>
                    </select>
                </td>
                <td><input type="text" placeholder="Item #" onchange="saveWorkOrders()"></td>
                <td><input type="text" placeholder="Customer Name" onchange="saveWorkOrders()"></td>
                <td><input type="text" placeholder="PO #" onchange="saveWorkOrders()"></td>
                <td>
                    <select onchange="handleProductTypeChange(this, ${rowIndex})">
                        <option value="">-- Select --</option>
                        <option value="Rolls">Rolls</option>
                        <option value="Sheets">Sheets</option>
                    </select>
                </td>
                <td><input type="text" placeholder="Color" onchange="saveWorkOrders()"></td>
                <td><input type="text" placeholder="Material" onchange="saveWorkOrders()"></td>
                <td><input type="text" placeholder="Length" onchange="saveWorkOrders()"></td>
                <td><input type="text" placeholder="Width" onchange="saveWorkOrders()"></td>
                <td><input type="text" placeholder="Gauge" onchange="saveWorkOrders()"></td>
                <td><input type="text" placeholder="Finish" onchange="saveWorkOrders()"></td>
                <td><input type="number" placeholder="0" onchange="saveWorkOrders()"></td>
                <td><input type="number" placeholder="0" onchange="saveWorkOrders()"></td>
                <td><input type="number" id="sheets${rowIndex}" placeholder="0" disabled onchange="saveWorkOrders()"></td>
                <td><input type="number" id="rolls${rowIndex}" placeholder="0" disabled onchange="saveWorkOrders()"></td>
                <td><textarea placeholder="Special instructions..." onchange="saveWorkOrders()" style="width: 100%; min-height: 40px; padding: 4px; border: 1px solid #9e9e9e; border-radius: 4px; font-size: 0.75em; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; resize: vertical;"></textarea></td>
                <td><button class="delete small" onclick="deleteWorkOrder(this)">Delete</button></td>
            `;
            
            saveWorkOrders();
        }

        function loadWorkOrders() {
            const tbody = document.getElementById('workOrderBody');
            tbody.innerHTML = '';
            
            workOrders.forEach((order, index) => {
                const row = tbody.insertRow();
                const rowIndex = Date.now() + index;
                
                row.innerHTML = `
                    <td><input type="date" value="${order.orderDate}" onchange="saveWorkOrders()"></td>
                    <td><input type="date" value="${order.dueDate}" onchange="saveWorkOrders()"></td>
                    <td><input type="text" value="${order.workOrder}" maxlength="6" onchange="saveWorkOrders()"></td>
                    <td>
                        <select onchange="saveWorkOrders()">
                            <option value="">-- Select --</option>
                            <option value="Line 2" ${order.lineNumber === 'Line 2' ? 'selected' : ''}>Line 2</option>
                            <option value="Line 3" ${order.lineNumber === 'Line 3' ? 'selected' : ''}>Line 3</option>
                            <option value="Line 4" ${order.lineNumber === 'Line 4' ? 'selected' : ''}>Line 4</option>
                        </select>
                    </td>
                    <td><input type="text" value="${order.itemNumber}" onchange="saveWorkOrders()"></td>
                    <td><input type="text" value="${order.customer}" onchange="saveWorkOrders()"></td>
                    <td><input type="text" value="${order.customerPO}" onchange="saveWorkOrders()"></td>
                    <td>
                        <select onchange="handleProductTypeChange(this, ${rowIndex})">
                            <option value="">-- Select --</option>
                            <option value="Rolls" ${order.productType === 'Rolls' ? 'selected' : ''}>Rolls</option>
                            <option value="Sheets" ${order.productType === 'Sheets' ? 'selected' : ''}>Sheets</option>
                        </select>
                    </td>
                    <td><input type="text" value="${order.color}" onchange="saveWorkOrders()"></td>
                    <td><input type="text" value="${order.material}" onchange="saveWorkOrders()"></td>
                    <td><input type="text" value="${order.length}" onchange="saveWorkOrders()"></td>
                    <td><input type="text" value="${order.width}" onchange="saveWorkOrders()"></td>
                    <td><input type="text" value="${order.gauge}" onchange="saveWorkOrders()"></td>
                    <td><input type="text" value="${order.finish}" onchange="saveWorkOrders()"></td>
                    <td><input type="number" value="${order.skidsRequested}" onchange="saveWorkOrders()"></td>
                    <td><input type="number" value="${order.totalPoundsRequested}" onchange="saveWorkOrders()"></td>
                    <td><input type="number" id="sheets${rowIndex}" value="${order.sheetsRequested || ''}" ${order.productType === 'Sheets' ? '' : 'disabled'} onchange="saveWorkOrders()"></td>
                    <td><input type="number" id="rolls${rowIndex}" value="${order.rollsRequested || ''}" ${order.productType === 'Rolls' ? '' : 'disabled'} onchange="saveWorkOrders()"></td>
                    <td><textarea onchange="saveWorkOrders()" style="width: 100%; min-height: 40px; padding: 4px; border: 1px solid #9e9e9e; border-radius: 4px; font-size: 0.75em; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; resize: vertical;">${order.specialInstructions || ''}</textarea></td>
                    <td><button class="delete small" onclick="deleteWorkOrder(this)">Delete</button></td>
                `;
            });
        }

        function saveWorkOrders() {
            const tbody = document.getElementById('workOrderBody');
            const rows = tbody.getElementsByTagName('tr');
            workOrders = [];
            
            for (let row of rows) {
                const inputs = row.getElementsByTagName('input');
                const selects = row.getElementsByTagName('select');
                const textareas = row.getElementsByTagName('textarea');
                workOrders.push({
                    orderDate: inputs[0].value,
                    dueDate: inputs[1].value,
                    workOrder: inputs[2].value,
                    lineNumber: selects[0].value,
                    itemNumber: inputs[3].value,
                    customer: inputs[4].value,
                    customerPO: inputs[5].value,
                    productType: selects[1].value,
                    color: inputs[6].value,
                    material: inputs[7].value,
                    length: inputs[8].value,
                    width: inputs[9].value,
                    gauge: inputs[10].value,
                    finish: inputs[11].value,
                    skidsRequested: inputs[12].value,
                    totalPoundsRequested: inputs[13].value,
                    sheetsRequested: inputs[14].value,
                    rollsRequested: inputs[15].value,
                    specialInstructions: textareas[0] ? textareas[0].value : ''
                });
            }
            
            localStorage.setItem('workOrders', JSON.stringify(workOrders));
            refreshDashboard();
        }

        function deleteWorkOrder(btn) {
            if (confirm('Are you sure you want to delete this work order?')) {
                btn.closest('tr').remove();
                saveWorkOrders();
            }
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL data including work orders, production records, scrap, and downtime.\n\nThis action cannot be undone. Are you absolutely sure?')) {
                if (confirm('Last confirmation: Delete everything?')) {
                    localStorage.clear();
                    
                    // FIXED: Reset settings properly and save them
                    systemSettings = { ...defaultSettings };
                    localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
                    
                    location.reload();
                }
            }
        }

        // ==================== OPERATOR FUNCTIONS (UPDATED WITH OPERATOR NAME) ====================
        function searchWorkOrder() {
            const woNumber = document.getElementById('searchWorkOrder').value.trim();
            if (!woNumber) {
                alert('Please enter a work order number');
                return;
            }
            
            const order = workOrders.find(o => o.workOrder === woNumber);
            if (!order) {
                alert('Work order not found!');
                return;
            }
            
            if (!order.productType || (order.productType !== 'Rolls' && order.productType !== 'Sheets')) {
                alert('WARNING: This work order does not have a Product Type specified (Rolls or Sheets).\n\nPlease have the Supervisor set the Product Type before starting production.');
                return;
            }
            
            const existingProduction = productionData.find(p => p.workOrder === woNumber);
            
            if (existingProduction && existingProduction.completed) {
                alert('This work order is already completed. No more entries can be added.');
                displayProduction(existingProduction);
                return;
            }
            
            // NEW: Get operator name if starting new production
            if (!existingProduction) {
                const operatorName = prompt('Enter Operator Name:', '');
                if (!operatorName || operatorName.trim() === '') {
                    alert('Operator name is required to start production');
                    return;
                }
                startProduction(order, operatorName.trim().toUpperCase());
            } else {
                displayProduction(existingProduction);
            }
        }

        function startProduction(order, operatorName) {
            const production = {
                workOrder: order.workOrder,
                customer: order.customer,
                itemNumber: order.itemNumber,
                startTime: getESTTimestamp(),
                startedBy: operatorName,  // NEW: Store who started production
                skids: [],
                completed: false
            };
            
            productionData.push(production);
            localStorage.setItem('productionData', JSON.stringify(productionData));
            displayProduction(production);
            refreshDashboard();
        }

        function displayProduction(production) {
            const order = workOrders.find(o => o.workOrder === production.workOrder);
            const isRolls = order && order.productType === 'Rolls';
            const isSheets = order && order.productType === 'Sheets';
            const skidsRequested = order ? parseInt(order.skidsRequested) || 0 : 0;
            const isCompleted = production.completed;
            
            const totalNet = production.skids.reduce((sum, s) => sum + parseFloat(s.netWeight || 0), 0);
            const totalGross = production.skids.reduce((sum, s) => sum + parseFloat(s.grossWeight || 0), 0);
            
            let totalRolls = 0;
            let totalSheets = 0;
            let totalRollWeight = 0;
            let totalRollLength = 0;
            
            if (isRolls) {
                production.skids.forEach(skid => {
                    if (skid.rolls && Array.isArray(skid.rolls)) {
                        totalRolls += skid.rolls.length;
                        skid.rolls.forEach(roll => {
                            totalRollWeight += parseFloat(roll.weight || 0);
                            totalRollLength += parseFloat(roll.length || 0);
                        });
                    }
                });
            } else if (isSheets) {
                totalSheets = production.skids.reduce((sum, s) => sum + parseInt(s.sheetCount || 0), 0);
            }
            
            const skidsArea = document.getElementById('productionArea');
            
            const currentSkidNum = production.skids.length + 1;
            if (!tempRolls[currentSkidNum]) {
                tempRolls[currentSkidNum] = [];
            }
            
            let completedSkidsHTML = '';
            for (let i = 0; i < production.skids.length; i++) {
                const skid = production.skids[i];
                const skidNum = i + 1;
                
                // FIXED: Parse timestamp to EST for display
                const displayTimestamp = parseTimestampToEST(skid.timestamp);
                
                if (isRolls) {
                    const rollsList = skid.rolls.map((r, idx) => {
                        const lengthText = r.length ? `, ${r.length} ft` : '';
                        return `<div style="padding: 5px; background: white; border-radius: 3px; margin: 3px 0; font-size: 0.85em;">
                            <strong>Roll ${idx + 1}:</strong> ${r.weight} lbs${lengthText}
                        </div>`;
                    }).join('');
                    
                    completedSkidsHTML += `
                        <div class="skid-card">
                            <div class="skid-card-header">
                                <div style="font-size: 1.1em; font-weight: bold; color: #2e7d32;">
                                    Skid #${skidNum}
                                    ${skid.operator ? `<span class="operator-badge">üë∑ ${skid.operator}</span>` : ''}
                                </div>
                                <div class="skid-actions">
                                    <button class="btn-edit" onclick="openEditSkidModal('${production.workOrder}', ${i})">‚úèÔ∏è Edit</button>
                                    <button class="btn-delete-skid" onclick="deleteSkid('${production.workOrder}', ${i})">üóëÔ∏è Delete</button>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-bottom: 10px; font-size: 0.85em;">
                                <div><strong>Gross Weight:</strong> ${skid.grossWeight} lbs</div>
                                <div><strong>Net Weight:</strong> ${skid.netWeight} lbs</div>
                                <div><strong>Roll Count:</strong> ${skid.rolls.length}</div>
                            </div>
                            <div style="font-size: 0.8em; color: #757575; margin-top: 5px;">
                                <strong>Recorded:</strong> ${displayTimestamp}
                                ${skid.lastEdited ? ` | <em>Last edited: ${parseTimestampToEST(skid.lastEdited)}</em>` : ''}
                            </div>
                            <div style="margin-top: 10px;">
                                <strong style="font-size: 0.85em;">Rolls:</strong>
                                <div style="margin-top: 5px;">${rollsList}</div>
                            </div>
                        </div>
                    `;
                } else if (isSheets) {
                    completedSkidsHTML += `
                        <div class="skid-card">
                            <div class="skid-card-header">
                                <div style="font-size: 1.1em; font-weight: bold; color: #2e7d32;">
                                    Skid #${skidNum}
                                    ${skid.operator ? `<span class="operator-badge">üë∑ ${skid.operator}</span>` : ''}
                                </div>
                                <div class="skid-actions">
                                    <button class="btn-edit" onclick="openEditSkidModal('${production.workOrder}', ${i})">‚úèÔ∏è Edit</button>
                                    <button class="btn-delete-skid" onclick="deleteSkid('${production.workOrder}', ${i})">üóëÔ∏è Delete</button>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-bottom: 10px; font-size: 0.85em;">
                                <div><strong>Gross Weight:</strong> ${skid.grossWeight} lbs</div>
                                <div><strong>Net Weight:</strong> ${skid.netWeight} lbs</div>
                                <div><strong>Sheet Count:</strong> ${skid.sheetCount}</div>
                            </div>
                            <div style="font-size: 0.8em; color: #757575; margin-top: 5px;">
                                <strong>Recorded:</strong> ${displayTimestamp}
                                ${skid.lastEdited ? ` | <em>Last edited: ${parseTimestampToEST(skid.lastEdited)}</em>` : ''}
                            </div>
                        </div>
                    `;
                }
            }
            
            let statsHTML = `
                <div class="stat-card">
                    <h4>Skids Completed</h4>
                    <div class="value">${production.skids.length} / ${skidsRequested}</div>
                </div>
                <div class="stat-card">
                    <h4>Total Gross Weight</h4>
                    <div class="value">${totalGross.toFixed(2)} lbs</div>
                </div>
                <div class="stat-card">
                    <h4>Total Net Weight</h4>
                    <div class="value">${totalNet.toFixed(2)} lbs</div>
                </div>
            `;
            
            if (isRolls) {
                statsHTML += `
                    <div class="stat-card">
                        <h4>Total Rolls</h4>
                        <div class="value">${totalRolls}</div>
                    </div>
                    <div class="stat-card">
                        <h4>Total Roll Weight</h4>
                        <div class="value">${totalRollWeight.toFixed(2)} lbs</div>
                    </div>
                    <div class="stat-card">
                        <h4>Total Roll Length</h4>
                        <div class="value">${totalRollLength.toFixed(0)} ft</div>
                    </div>
                `;
            } else if (isSheets) {
                statsHTML += `
                    <div class="stat-card">
                        <h4>Total Sheets</h4>
                        <div class="value">${totalSheets}</div>
                    </div>
                `;
            }
            
            const unsavedBanner = showUnsavedBanner(currentSkidNum);
            
            let newSkidEntryHTML = '';
            if (!isCompleted && production.skids.length < skidsRequested) {
                if (isRolls) {
                    const currentRolls = tempRolls[currentSkidNum] || [];
                    let rollsListHTML = '';
                    if (currentRolls.length > 0) {
                        rollsListHTML = currentRolls.map((roll, idx) => {
                            const lengthText = roll.length ? `, ${roll.length} ft` : '';
                            return `
                            <div class="roll-summary">
                                <span><strong>Roll ${idx + 1}:</strong> ${roll.weight} lbs${lengthText}</span>
                                <button class="delete small" onclick="removeRoll(${currentSkidNum}, ${idx})">Remove</button>
                            </div>
                        `}).join('');
                    }
                    
                    newSkidEntryHTML = `
                        ${unsavedBanner}
                        <div class="roll-entry-section">
                            <h4>Enter New Skid #${currentSkidNum}</h4>
                            
                            <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                                    <div class="form-group">
                                        <label>Gross Weight (lbs)</label>
                                        <input type="number" id="gross${currentSkidNum}" step="0.01" placeholder="0.00">
                                    </div>
                                    <div class="form-group">
                                        <label>Net Weight (lbs)</label>
                                        <input type="number" id="net${currentSkidNum}" step="0.01" placeholder="0.00">
                                    </div>
                                </div>
                            </div>
                            
                            <h4 style="margin-top: 20px;">Add Rolls to This Skid</h4>
                            <div class="alert info" style="margin: 10px 0;">
                                <strong>Instructions:</strong> Enter each roll individually. Weight is required, length is optional. You can add multiple rolls to this skid. Click "Save Skid" when all rolls are entered.
                            </div>
                            
                            <div class="roll-input-row">
                                <label>Roll ${currentRolls.length + 1}</label>
                                <div>
                                    <label style="font-size: 0.8em; font-weight: normal;">Weight (lbs) *</label>
                                    <input type="number" id="rollWeight${currentSkidNum}" step="0.01" placeholder="0.00">
                                </div>
                                <div>
                                    <label style="font-size: 0.8em; font-weight: normal;">Length (ft) - Optional</label>
                                    <input type="number" id="rollLength${currentSkidNum}" step="1" placeholder="0">
                                </div>
                                <button onclick="addRollToSkid(${currentSkidNum})">+ Add Roll</button>
                            </div>
                            
                            ${currentRolls.length > 0 ? `
                                <div class="rolls-list">
                                    <h4 style="margin-top: 20px;">Rolls in This Skid (${currentRolls.length})</h4>
                                    ${rollsListHTML}
                                </div>
                            ` : '<p style="color: #757575; margin: 15px 0; font-size: 0.9em;">No rolls added yet. Add at least one roll to this skid.</p>'}
                            
                            <div style="margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 5px; font-size: 0.9em;">
                                <strong>Total Rolls in Skid:</strong> ${currentRolls.length} | 
                                <strong>Total Weight:</strong> ${currentRolls.reduce((sum, r) => sum + parseFloat(r.weight), 0).toFixed(2)} lbs | 
                                <strong>Total Length:</strong> ${currentRolls.reduce((sum, r) => sum + parseFloat(r.length || 0), 0).toFixed(0)} ft
                            </div>
                            
                            <button 
                                onclick="saveSkidWithRolls(${currentSkidNum}, '${production.workOrder}')" 
                                style="margin-top: 20px; background: #2e7d32; font-size: 1.05em; padding: 15px 30px;"
                                ${currentRolls.length === 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                                Save Skid #${currentSkidNum} (${currentRolls.length} roll${currentRolls.length !== 1 ? 's' : ''})
                            </button>
                        </div>
                    `;
                } else if (isSheets) {
                    newSkidEntryHTML = `
                        <div class="roll-entry-section">
                            <h4>Enter New Skid #${currentSkidNum}</h4>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                                <div class="form-group">
                                    <label>Gross Weight (lbs)</label>
                                    <input type="number" id="gross${currentSkidNum}" step="0.01" placeholder="0.00">
                                </div>
                                <div class="form-group">
                                    <label>Net Weight (lbs)</label>
                                    <input type="number" id="net${currentSkidNum}" step="0.01" placeholder="0.00">
                                </div>
                                <div class="form-group">
                                    <label>Sheet Count</label>
                                    <input type="number" id="sheetCount${currentSkidNum}" placeholder="0">
                                </div>
                            </div>
                            
                            <button onclick="saveSkidSheets(${currentSkidNum}, '${production.workOrder}')" style="margin-top: 15px;">
                                Save Skid #${currentSkidNum}
                            </button>
                        </div>
                    `;
                }
            }
            
            let completionSection = '';
            if (isCompleted) {
                completionSection = `
                    <div class="alert success">
                        This work order was completed on ${parseTimestampToEST(production.endTime)}
                        <br>No more data can be entered for this order.
                    </div>
                `;
            } else if (production.skids.length === skidsRequested) {
                completionSection = `
                    <button onclick="completeProduction('${production.workOrder}')" style="background: #2e7d32; font-size: 1.15em; padding: 15px 30px;">
                        Complete Production
                    </button>
                `;
            } else {
                completionSection = `
                    <p style="color: #f57c00; font-weight: bold; font-size: 0.9em;">Enter all ${skidsRequested} skids before completing production (${production.skids.length} of ${skidsRequested} complete)</p>
                `;
            }
            
            skidsArea.innerHTML = `
                <div class="production-card">
                    <h3>${production.workOrder} - ${order.productType || 'N/A'}</h3>
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #1565c0;">
                        <h4 style="color: #1565c0; margin-bottom: 10px;">Work Order Details</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; font-size: 0.85em;">
                            <div><strong>Customer:</strong> ${order.customer || 'N/A'}</div>
                            <div><strong>Item #:</strong> ${order.itemNumber || 'N/A'}</div>
                            <div><strong>Line:</strong> ${order.lineNumber || 'N/A'}</div>
                            <div><strong>Customer PO:</strong> ${order.customerPO || 'N/A'}</div>
                            <div><strong>Order Date:</strong> ${order.orderDate || 'N/A'}</div>
                            <div><strong>Due Date:</strong> ${order.dueDate || 'N/A'}</div>
                            <div><strong>Color:</strong> ${order.color || 'N/A'}</div>
                            <div><strong>Material:</strong> ${order.material || 'N/A'}</div>
                            <div><strong>Gauge:</strong> ${order.gauge || 'N/A'}</div>
                            <div><strong>Width:</strong> ${order.width || 'N/A'}</div>
                            <div><strong>Finish:</strong> ${order.finish || 'N/A'}</div>
                            <div><strong>Length:</strong> ${order.length || 'N/A'}"</div>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 3px; font-size: 0.85em;">
                            <strong>Product Type:</strong> <span style="color: #C00000; font-size: 1.05em;">${order.productType || 'NOT SPECIFIED'}</span>
                            ${isRolls ? ' | <strong>Rolls Requested:</strong> ' + (order.rollsRequested || 'N/A') : ''}
                            ${isSheets ? ' | <strong>Sheets Requested:</strong> ' + (order.sheetsRequested || 'N/A') : ''}
                            | <strong>Total Pounds:</strong> ${order.totalPoundsRequested || 'N/A'} lbs
                        </div>
                        ${order.specialInstructions ? `
                            <div style="margin-top: 10px; padding: 12px; background: #fff3e0; border-radius: 3px; border-left: 4px solid #f57c00;">
                                <strong style="color: #e65100; display: block; margin-bottom: 8px; font-size: 0.9em;">üìã SPECIAL INSTRUCTIONS:</strong>
                                <div style="font-size: 0.95em; line-height: 1.4; color: #424242; white-space: pre-wrap;">${order.specialInstructions}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="compact-stat">
                        <span><strong>Started:</strong> ${parseTimestampToEST(production.startTime)}</span>
                        <span><strong>Started By:</strong> ${production.startedBy || 'N/A'}</span>
                        <span><strong>Skids Required:</strong> ${skidsRequested}</span>
                    </div>
                    ${isCompleted ? `<div class="compact-stat" style="background: #e8f5e9;"><span><strong>Status:</strong> COMPLETED</span></div>` : ''}
                    
                    <div class="stats">
                        ${statsHTML}
                    </div>
                    
                    ${completedSkidsHTML ? `
                        <h3 style="margin-top: 30px;">Completed Skids (${production.skids.length})</h3>
                        ${completedSkidsHTML}
                    ` : ''}
                    
                    ${production.skids.length > 0 ? `
                        <div class="label-actions">
                            <h4 style="margin: 0; flex: 1;">Production Reports & Labels:</h4>
                            <button onclick="printProductionReport('${production.workOrder}')" style="background: #2e7d32; font-size: 1.05em; padding: 10px 20px;">
                                üìÑ Print Production Report
                            </button>
                            ${production.skids.map((skid, idx) => `
                                <button onclick="printSkidLabel('${production.workOrder}', ${idx})" style="background: #616161;">
                                    Print Skid #${idx + 1} Label
                                </button>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${newSkidEntryHTML}
                    
                    <div style="margin-top: 20px;">
                        ${completionSection}
                    </div>
                </div>
            `;
            
            displayDowntimeTab(production, isCompleted);
        }

        function addRollToSkid(skidNum) {
            const weight = parseFloat(document.getElementById('rollWeight' + skidNum).value);
            const lengthInput = document.getElementById('rollLength' + skidNum);
            const length = lengthInput.value ? parseFloat(lengthInput.value) : null;
            
            if (!validatePositiveNumber(weight, 'Roll weight')) {
                return;
            }
            
            if (length !== null && length <= 0) {
                alert('Length must be greater than 0 if provided');
                return;
            }
            
            if (!tempRolls[skidNum]) {
                tempRolls[skidNum] = [];
            }
            
            tempRolls[skidNum].push({
                weight: weight,
                length: length
            });
            
            saveTempRolls();
            
            document.getElementById('rollWeight' + skidNum).value = '';
            document.getElementById('rollLength' + skidNum).value = '';
            
            const woNumber = document.getElementById('searchWorkOrder').value.trim();
            const production = productionData.find(p => p.workOrder === woNumber);
            if (production) {
                displayProduction(production);
            }
        }

        function removeRoll(skidNum, rollIndex) {
            if (confirm('Remove this roll?')) {
                tempRolls[skidNum].splice(rollIndex, 1);
                saveTempRolls();
                
                const woNumber = document.getElementById('searchWorkOrder').value.trim();
                const production = productionData.find(p => p.workOrder === woNumber);
                if (production) {
                    displayProduction(production);
                }
            }
        }

        function saveSkidWithRolls(skidNum, woNumber) {
            const production = productionData.find(p => p.workOrder === woNumber);
            
            if (!production) {
                alert('Production not found');
                return;
            }
            
            if (production.completed) {
                alert('This work order is completed. No more entries allowed.');
                return;
            }
            
            const order = workOrders.find(o => o.workOrder === woNumber);
            if (!order || order.productType !== 'Rolls') {
                alert('ERROR: This work order is not set up for ROLLS.\n\nProduct Type: ' + (order ? order.productType : 'Unknown') + '\n\nPlease check the work order details.');
                return;
            }
            
            const gross = parseFloat(document.getElementById('gross' + skidNum).value);
            const net = parseFloat(document.getElementById('net' + skidNum).value);
            
            if (!validateWeight(gross, net, 'Skid weight')) {
                return;
            }
            
            if (!tempRolls[skidNum] || tempRolls[skidNum].length === 0) {
                alert('Please add at least one roll to this skid');
                return;
            }
            
            // NEW: Prompt for operator name
            const operatorName = prompt('Enter Operator Name for this skid:', '');
            if (!operatorName || operatorName.trim() === '') {
                alert('Operator name is required to save this skid');
                return;
            }
            
            production.skids.push({
                grossWeight: gross,
                netWeight: net,
                rolls: [...tempRolls[skidNum]],
                timestamp: getESTTimestamp(),
                operator: operatorName.trim().toUpperCase()  // NEW: Store operator name
            });
            
            tempRolls[skidNum] = [];
            saveTempRolls();
            
            localStorage.setItem('productionData', JSON.stringify(productionData));
            displayProduction(production);
            refreshDashboard();
        }

        function saveSkidSheets(skidNum, woNumber) {
            const production = productionData.find(p => p.workOrder === woNumber);
            
            if (!production) {
                alert('Production not found');
                return;
            }
            
            if (production.completed) {
                alert('This work order is completed. No more entries allowed.');
                return;
            }
            
            const order = workOrders.find(o => o.workOrder === woNumber);
            if (!order || order.productType !== 'Sheets') {
                alert('ERROR: This work order is not set up for SHEETS.\n\nProduct Type: ' + (order ? order.productType : 'Unknown') + '\n\nPlease check the work order details.');
                return;
            }
            
            const gross = parseFloat(document.getElementById('gross' + skidNum).value);
            const net = parseFloat(document.getElementById('net' + skidNum).value);
            const sheetCount = parseInt(document.getElementById('sheetCount' + skidNum).value);
            
            if (!validateWeight(gross, net, 'Skid weight')) {
                return;
            }
            
            if (!validatePositiveNumber(sheetCount, 'Sheet count')) {
                return;
            }
            
            // NEW: Prompt for operator name
            const operatorName = prompt('Enter Operator Name for this skid:', '');
            if (!operatorName || operatorName.trim() === '') {
                alert('Operator name is required to save this skid');
                return;
            }
            
            production.skids.push({
                grossWeight: gross,
                netWeight: net,
                sheetCount: sheetCount,
                timestamp: getESTTimestamp(),
                operator: operatorName.trim().toUpperCase()  // NEW: Store operator name
            });
            
            localStorage.setItem('productionData', JSON.stringify(productionData));
            displayProduction(production);
            refreshDashboard();
        }

        function displayDowntimeTab(production, isCompleted) {
            const downtimeArea = document.getElementById('downtimeArea');
            const totalDowntime = downtimeData
                .filter(d => d.workOrder === production.workOrder)
                .reduce((sum, d) => sum + parseFloat(d.duration || 0), 0);
            
            downtimeArea.innerHTML = `
                <div class="production-card">
                    <h3>Downtime: ${production.workOrder}</h3>
                    
                    <div class="compact-stat">
                        <span><strong>Customer:</strong> ${production.customer}</span>
                        <span><strong>Item:</strong> ${production.itemNumber}</span>
                    </div>
                    ${isCompleted ? `<div class="compact-stat" style="background: #e8f5e9;"><span><strong>Status:</strong> COMPLETED (Downtime can still be recorded)</span></div>` : ''}
                    
                    <div class="stats">
                        <div class="stat-card">
                            <h4>Total Downtime Events</h4>
                            <div class="value">${downtimeData.filter(d => d.workOrder === production.workOrder).length}</div>
                        </div>
                        <div class="stat-card">
                            <h4>Total Downtime</h4>
                            <div class="value">${totalDowntime} min</div>
                        </div>
                        <div class="stat-card">
                            <h4>Total Downtime</h4>
                            <div class="value">${(totalDowntime / 60).toFixed(2)} hrs</div>
                        </div>
                    </div>
                    
                    <h4>Record Downtime</h4>
                    ${isCompleted ? '<p style="color: #2e7d32; font-size: 0.85em; margin: 10px 0;"><strong>Note:</strong> You can record downtime even for completed orders.</p>' : ''}
                    <div class="inline-form">
                        <div class="form-group">
                            <label>Downtime Type</label>
                            <select id="downtimeType">
                                <option value="">-- Select Type --</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Setup/Changeover">Setup/Changeover</option>
                                <option value="Material Shortage">Material Shortage</option>
                                <option value="Equipment Failure">Equipment Failure</option>
                                <option value="Quality Issue">Quality Issue</option>
                                <option value="Break">Break</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Duration (minutes)</label>
                            <input type="number" id="downtimeDuration" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Reason</label>
                            <input type="text" id="downtimeReason" placeholder="Description">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button onclick="addDowntime('${production.workOrder}')">Record Downtime</button>
                        </div>
                    </div>
                    
                    <h4>Downtime History</h4>
                    <div class="scrollable-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Timestamp (EST)</th>
                                    <th>Type</th>
                                    <th>Duration</th>
                                    <th>Reason</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${downtimeData.filter(d => d.workOrder === production.workOrder).map((dt, idx) => `
                                    <tr>
                                        <td>${parseTimestampToEST(dt.timestamp)}</td>
                                        <td>${dt.type}</td>
                                        <td>${dt.duration} min</td>
                                        <td>${dt.reason}</td>
                                        <td><button class="delete" onclick="deleteDowntime(${downtimeData.indexOf(dt)})">Delete</button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function addDowntime(woNumber) {
            const type = document.getElementById('downtimeType').value;
            const duration = document.getElementById('downtimeDuration').value;
            const reason = document.getElementById('downtimeReason').value;
            
            if (!type) {
                alert('Please select a downtime type');
                return;
            }
            
            if (!validatePositiveNumber(parseFloat(duration), 'Downtime duration')) {
                return;
            }
            
            downtimeData.push({
                workOrder: woNumber,
                type: type,
                duration: duration,
                reason: reason,
                timestamp: getESTTimestamp()
            });
            
            localStorage.setItem('downtimeData', JSON.stringify(downtimeData));
            
            const production = productionData.find(p => p.workOrder === woNumber);
            if (production) {
                displayProduction(production);
            }
            refreshDashboard();
            
            document.getElementById('downtimeType').value = '';
            document.getElementById('downtimeDuration').value = '';
            document.getElementById('downtimeReason').value = '';
        }

        function deleteDowntime(index) {
            if (confirm('Delete this downtime record?')) {
                const woNumber = downtimeData[index].workOrder;
                downtimeData.splice(index, 1);
                localStorage.setItem('downtimeData', JSON.stringify(downtimeData));
                
                const production = productionData.find(p => p.workOrder === woNumber);
                if (production) {
                    displayProduction(production);
                }
                refreshDashboard();
            }
        }

        function completeProduction(woNumber) {
            if (confirm('Mark this production as complete?')) {
                const production = productionData.find(p => p.workOrder === woNumber && !p.completed);
                if (production) {
                    production.completed = true;
                    production.endTime = getESTTimestamp();
                    
                    for (let skidNum in tempRolls) {
                        tempRolls[skidNum] = [];
                    }
                    saveTempRolls();
                    
                    localStorage.setItem('productionData', JSON.stringify(productionData));
                    
                    document.getElementById('productionArea').innerHTML = `
                        <div class="alert success">
                            Production for ${woNumber} marked as complete!
                        </div>
                    `;
                    
                    refreshDashboard();
                }
            }
        }

        // ==================== QC FUNCTIONS ====================
function selectQCWorkOrder() {
    const woNumber = document.getElementById('qcWorkOrderInput').value.trim().toUpperCase();
    
    if (!woNumber) {
        alert('Please enter a work order number');
        return;
    }
    
    const order = workOrders.find(o => o.workOrder.toUpperCase() === woNumber);
    if (!order) {
        alert('Work order not found!\n\nPlease check the work order number and try again.');
        return;
    }
    
    selectedQCWorkOrder = order.workOrder;
    
    // Show the selected work order info
    document.getElementById('qcWorkOrderInfo').style.display = 'block';
    document.getElementById('qcWorkOrderDetails').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; font-size: 0.85em;">
            <div><strong>Work Order #:</strong> ${order.workOrder}</div>
            <div><strong>Customer:</strong> ${order.customer || 'N/A'}</div>
            <div><strong>Item #:</strong> ${order.itemNumber || 'N/A'}</div>
            <div><strong>Line:</strong> ${order.lineNumber || 'N/A'}</div>
            <div><strong>Product Type:</strong> ${order.productType || 'N/A'}</div>
        </div>
    `;
    
    // Hide the warning alert
    document.getElementById('scrapEntryAlert').style.display = 'none';
    
    // Reload scrap history with filter
    loadScrapHistory();
}

function clearQCWorkOrderSelection() {
    selectedQCWorkOrder = '';
    document.getElementById('qcWorkOrderInfo').style.display = 'none';
    document.getElementById('qcWorkOrderInput').value = '';
    document.getElementById('scrapEntryAlert').style.display = 'block';
    
    // Reload scrap history to show all records
    loadScrapHistory();
}
function recordScrap() {
    const type = document.getElementById('scrapType').value;
    const weight = document.getElementById('scrapWeight').value;
    const reason = document.getElementById('scrapReason').value;
    
    if (!selectedQCWorkOrder) {
        alert('Please select a work order first');
        document.getElementById('scrapEntryAlert').style.display = 'block';
        return;
    }
    
    if (!type || !weight) {
        alert('Please enter scrap type and weight');
        return;
    }
    
    if (!validatePositiveNumber(parseFloat(weight), 'Scrap weight')) {
        return;
    }
    
    // Prompt for operator name
    const operatorName = prompt('Enter Operator Name for this scrap record:', '');
    if (!operatorName || operatorName.trim() === '') {
        alert('Operator name is required to record scrap');
        return;
    }
    
    scrapData.push({
        workOrder: selectedQCWorkOrder,
        type: type,
        weight: parseFloat(weight),
        reason: reason,
        operator: operatorName.trim().toUpperCase(),
        timestamp: getESTTimestamp()
    });
    
    localStorage.setItem('scrapData', JSON.stringify(scrapData));
    loadScrapHistory();
    refreshDashboard();
    
    // Clear the form
    document.getElementById('scrapType').value = '';
    document.getElementById('scrapWeight').value = '';
    document.getElementById('scrapReason').value = '';
    
    // Show success message
    const alert = document.createElement('div');
    alert.className = 'alert success';
    alert.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; animation: slideIn 0.3s ease;';
    alert.innerHTML = `
        <strong>‚úì Scrap Recorded!</strong><br>
        ${parseFloat(weight).toFixed(2)} lbs added to ${selectedQCWorkOrder}
    `;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => alert.remove(), 300);
    }, 3000);
}

function loadScrapHistory() {
    const tbody = document.getElementById('scrapBody');
    const filterStatus = document.getElementById('scrapFilterStatus');
    tbody.innerHTML = '';
    
    // Filter scrap data
    const filtered = selectedQCWorkOrder 
        ? scrapData.filter(s => s.workOrder === selectedQCWorkOrder) 
        : scrapData;
    
    // Update filter status display
    if (selectedQCWorkOrder) {
        filterStatus.innerHTML = `<strong>Filtering:</strong> ${selectedQCWorkOrder} (${filtered.length} record${filtered.length !== 1 ? 's' : ''})`;
        filterStatus.style.color = '#1565c0';
    } else {
        filterStatus.innerHTML = `Showing all scrap records (${filtered.length} total)`;
        filterStatus.style.color = '#757575';
    }
    
    // Display filtered results
    if (filtered.length === 0) {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td colspan="7" style="text-align: center; color: #757575; padding: 30px; font-style: italic;">
                ${selectedQCWorkOrder 
                    ? `No scrap records found for work order ${selectedQCWorkOrder}` 
                    : 'No scrap records have been entered yet'}
            </td>
        `;
        return;
    }
    
    // Sort by timestamp (most recent first)
    const sorted = filtered.sort((a, b) => {
        return new Date(b.timestamp) - new Date(a.timestamp);
    });
    
    sorted.forEach((scrap) => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${parseTimestampToEST(scrap.timestamp)}</td>
            <td><strong>${scrap.workOrder}</strong></td>
            <td>${scrap.type}</td>
            <td>${scrap.weight.toFixed(2)}</td>
            <td>${scrap.reason}</td>
            <td>${scrap.operator || 'N/A'}</td>
            <td><button class="delete" onclick="deleteScrap(${scrapData.indexOf(scrap)})">Delete</button></td>
        `;
    });
}
        function deleteScrap(index) {
            if (confirm('Delete this scrap record?')) {
                scrapData.splice(index, 1);
                localStorage.setItem('scrapData', JSON.stringify(scrapData));
                loadScrapHistory();
                refreshDashboard();
            }
        }

        // ==================== DASHBOARD FUNCTIONS ====================
        function refreshDashboard() {
            const summaryDiv = document.getElementById('dashboardSummary');
            
            if (!workOrders.length) {
                summaryDiv.innerHTML = '<p style="color: #757575; margin: 10px 0; font-size: 0.85em;">No work orders created yet.</p>';
                return;
            }
            
            let totalOrders = workOrders.length;
            let inProgress = 0;
            let completed = 0;
            let notStarted = 0;
            
            workOrders.forEach(order => {
                const prod = productionData.find(p => p.workOrder === order.workOrder);
                if (!prod) {
                    notStarted++;
                } else if (prod.completed) {
                    completed++;
                } else {
                    inProgress++;
                }
            });
            
            summaryDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 10px;">
                    <div class="mini-stat">
                        <strong>Total Orders:</strong> ${totalOrders}
                    </div>
                    <div class="mini-stat" style="background: #e8f5e9;">
                        <strong>Completed:</strong> ${completed}
                    </div>
                    <div class="mini-stat" style="background: #fff3e0;">
                        <strong>In Progress:</strong> ${inProgress}
                    </div>
                    <div class="mini-stat" style="background: #ffebee;">
                        <strong>Not Started:</strong> ${notStarted}
                    </div>
                </div>
            `;
        }

        function hideFullDashboard() {
            document.getElementById('fullDashboard').style.display = 'none';
            document.getElementById('showDashboardBtn').style.display = 'inline-block';
            document.getElementById('hideDashboardBtn').style.display = 'none';
        }

        function buildFullDashboard() {
            const dashDiv = document.getElementById('fullDashboard');
            dashDiv.style.display = 'block';
            
            // Toggle buttons
            document.getElementById('showDashboardBtn').style.display = 'none';
            document.getElementById('hideDashboardBtn').style.display = 'inline-block';
            
            if (!workOrders.length) {
                dashDiv.innerHTML = '<div class="alert error">No work orders available. Please create work orders in the Supervisor section.</div>';
                return;
            }
            
            // Initialize all totals
            let totalSkidsRequired = 0;
            let totalSkidsRequested = 0;
            let totalSkidsProduced = 0;
            let totalNetWeight = 0;
            let totalScrap = 0;
            let totalDowntime = 0;
            
            workOrders.forEach(order => {
                const skidsReq = parseInt(order.skidsRequested) || 0;
                totalSkidsRequired += skidsReq;
                totalSkidsRequested += skidsReq;
                
                const prod = productionData.find(p => p.workOrder === order.workOrder);
                if (prod) {
                    totalSkidsProduced += prod.skids.length;
                    prod.skids.forEach(skid => {
                        totalNetWeight += parseFloat(skid.netWeight) || 0;
                    });
                }
            });
            
            scrapData.forEach(scrap => {
                totalScrap += parseFloat(scrap.weight) || 0;
            });
            
            downtimeData.forEach(dt => {
                totalDowntime += parseFloat(dt.duration) || 0;
            });
            
            // FIXED: Start with shift breakdown
            let html = '';
            
            // Group data by shifts
            const shiftData = groupByShifts();
            
            // Display shift breakdown FIRST
            html += '<h3>üìÖ Breakdown by Shift</h3>';
            html += '<div class="alert info" style="margin-bottom: 15px;">';
            html += '<strong>Shift Accounting:</strong> Each production day counts BOTH shifts:<br>';
            html += '‚Ä¢ <strong>1st Shift:</strong> 6:00 AM - 6:00 PM<br>';
            html += '‚Ä¢ <strong>2nd Shift:</strong> 6:00 PM - 6:00 AM (crosses midnight into next calendar day)<br><br>';
            html += '<em>Example: October 7th production day includes 1st shift on 10/7 (6AM-6PM) and 2nd shift starting 10/7 at 6PM through 10/8 at 6AM.</em><br><br>';
            html += '<span class="timezone-badge">All times shown in EST</span>';
            html += '</div>';
            
            // FIXED: Get sorted dates and include today
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayKey = today.toISOString().split('T')[0];
            
            // Ensure today is in shiftData even if no data yet
            if (!shiftData[todayKey]) {
                shiftData[todayKey] = {
                    shift1: { 
                        skids: 0, netWeight: 0, rolls: 0, sheets: 0, rollWeight: 0, rollLength: 0, scrap: 0, downtime: 0,
                        lines: {
                            'Line 2': { skids: 0, netWeight: 0, rolls: 0, sheets: 0, rollWeight: 0, rollLength: 0, scrap: 0, downtime: 0 },
                            'Line 3': { skids: 0, netWeight: 0, rolls: 0, sheets: 0, rollWeight: 0, rollLength: 0, scrap: 0, downtime: 0 },
                            'Line 4': { skids: 0, netWeight: 0, rolls: 0, sheets: 0, rollWeight: 0, rollLength: 0, scrap: 0, downtime: 0 }
                        }
                    },
                    shift2: { 
                        skids: 0, netWeight: 0, rolls: 0, sheets: 0, rollWeight: 0, rollLength: 0, scrap: 0, downtime: 0,
                        lines: {
                            'Line 2': { skids: 0, netWeight: 0, rolls: 0, sheets: 0, rollWeight: 0, rollLength: 0, scrap: 0, downtime: 0 },
                            'Line 3': { skids: 0, netWeight: 0, rolls: 0, sheets: 0, rollWeight: 0, rollLength: 0, scrap: 0, downtime: 0 },
                            'Line 4': { skids: 0, netWeight: 0, rolls: 0, sheets: 0, rollWeight: 0, rollLength: 0, scrap: 0, downtime: 0 }
                        }
                    }
                };
            }
            
            const sortedDates = Object.keys(shiftData).sort().reverse();
            
            if (sortedDates.length === 0) {
                html += '<div class="alert warning">No production data recorded yet. Shift breakdown will appear once production begins.</div>';
            } else {
                // FIXED: Always default to today
                const defaultDate = todayKey;
                
                html += '<div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px;">';
                html += '<div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">';
                html += '<label style="font-weight: bold; color: #212121;">Select Production Day:</label>';
                html += '<select id="shiftDateSelector" onchange="updateShiftBreakdown()" style="padding: 8px 12px; font-size: 0.9em; border: 2px solid #C00000; border-radius: 5px; background: white; cursor: pointer;">';
                
                sortedDates.forEach(dateKey => {
                    const date = new Date(dateKey + 'T12:00:00'); // Force noon to avoid timezone issues
                    const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                    const selected = dateKey === defaultDate ? 'selected' : '';
                    const isToday = dateKey === todayKey ? ' (TODAY)' : '';
                    html += `<option value="${dateKey}" ${selected}>${dateStr}${isToday}</option>`;
                });
                
                html += '</select>';
                html += '<span style="color: #757575; font-size: 0.85em;">(Showing most recent production days)</span>';
                html += '</div>';
                html += '</div>';
                
                html += '<div id="shiftBreakdownContainer"></div>';
            }
            
            // THEN show Overall Production Totals
            html += '<h3 style="margin-top: 50px;">üìä Overall Production Totals</h3>';
            html += '<div class="stats" style="margin-bottom: 30px;">';
            html += `
                <div class="stat-card">
                    <h4>Total Skids Progress</h4>
                    <div class="value">${totalSkidsProduced} / ${totalSkidsRequested}</div>
                </div>
                <div class="stat-card">
                    <h4>Total Net Production</h4>
                    <div class="value">${totalNetWeight.toFixed(2)} lbs</div>
                </div>
                <div class="stat-card">
                    <h4>Total Scrap</h4>
                    <div class="value">${totalScrap.toFixed(2)} lbs</div>
                </div>
                <div class="stat-card">
                    <h4>Total Downtime</h4>
                    <div class="value">${(totalDowntime / 60).toFixed(1)} hrs</div>
                </div>
            `;
            html += '</div>';
            
            html += '<h3 style="margin-top: 40px;">üìã Work Order Progress Details</h3>';
            
            // Add sort controls
            html += '<div class="sort-controls">';
            html += '<h4>üîΩ Sort By:</h4>';
            html += '<div class="sort-button-group">';
            html += '<button class="sort-btn" onclick="sortWorkOrders(\'workOrder\')">Work Order #</button>';
            html += '<button class="sort-btn" onclick="sortWorkOrders(\'customer\')">Customer</button>';
            html += '<button class="sort-btn" onclick="sortWorkOrders(\'line\')">Line</button>';
            html += '<button class="sort-btn" onclick="sortWorkOrders(\'status\')">Status</button>';
            html += '<button class="sort-btn" onclick="sortWorkOrders(\'produced\')">Produced (lbs)</button>';
            html += '<button class="sort-btn" onclick="sortWorkOrders(\'progress\')">Progress %</button>';
            html += '<button class="sort-btn" onclick="sortWorkOrders(\'dueDate\')">Due Date</button>';
            html += '</div>';
            html += '</div>';
            
            html += '<div class="scrollable-table" style="max-height: none;">';
            html += '<table id="workOrderProgressTable">';
            html += '<thead><tr>';
            html += '<th class="sortable-header" onclick="sortWorkOrders(\'workOrder\')">Work Order # <span class="sort-indicator">‚áÖ</span></th>';
            html += '<th class="sortable-header" onclick="sortWorkOrders(\'customer\')">Customer <span class="sort-indicator">‚áÖ</span></th>';
            html += '<th class="sortable-header" onclick="sortWorkOrders(\'line\')">Line <span class="sort-indicator">‚áÖ</span></th>';
            html += '<th class="sortable-header" onclick="sortWorkOrders(\'productType\')">Product Type <span class="sort-indicator">‚áÖ</span></th>';
            html += '<th class="sortable-header" onclick="sortWorkOrders(\'status\')">Status <span class="sort-indicator">‚áÖ</span></th>';
            html += '<th class="sortable-header" onclick="sortWorkOrders(\'skids\')">Skids <span class="sort-indicator">‚áÖ</span></th>';
            html += '<th class="sortable-header" onclick="sortWorkOrders(\'requested\')">Requested (lbs) <span class="sort-indicator">‚áÖ</span></th>';
            html += '<th class="sortable-header" onclick="sortWorkOrders(\'produced\')">Produced (lbs) <span class="sort-indicator">‚áÖ</span></th>';
            html += '<th class="sortable-header" onclick="sortWorkOrders(\'scrap\')">Scrap (lbs) <span class="sort-indicator">‚áÖ</span></th>';
            html += '<th class="sortable-header" onclick="sortWorkOrders(\'downtime\')">Downtime (hrs) <span class="sort-indicator">‚áÖ</span></th>';
            html += '<th class="sortable-header" onclick="sortWorkOrders(\'progress\')">Progress % <span class="sort-indicator">‚áÖ</span></th>';
            html += '</tr></thead><tbody id="workOrderProgressBody">';
            
            workOrders.forEach(order => {
                const prod = productionData.find(p => p.workOrder === order.workOrder);
                const skidsRequested = parseInt(order.skidsRequested) || 0;
                const poundsRequested = parseFloat(order.totalPoundsRequested) || 0;
                
                let status = 'Not Started';
                let statusColor = '#ffebee';
                let skidsProduced = 0;
                let poundsProduced = 0;
                
                if (prod) {
                    skidsProduced = prod.skids.length;
                    prod.skids.forEach(skid => {
                        poundsProduced += parseFloat(skid.netWeight) || 0;
                    });
                    
                    if (prod.completed) {
                        status = 'Completed';
                        statusColor = '#e8f5e9';
                    } else {
                        status = 'In Progress';
                        statusColor = '#fff3e0';
                    }
                }
                
                const woScrap = scrapData
                    .filter(s => s.workOrder === order.workOrder)
                    .reduce((sum, s) => sum + parseFloat(s.weight || 0), 0);
                
                const woDowntime = downtimeData
                    .filter(d => d.workOrder === order.workOrder)
                    .reduce((sum, d) => sum + parseFloat(d.duration || 0), 0);
                
                let progressPct = 0;
                if (poundsRequested > 0) {
                    progressPct = (poundsProduced / poundsRequested * 100).toFixed(1);
                } else if (skidsRequested > 0) {
                    progressPct = (skidsProduced / skidsRequested * 100).toFixed(1);
                }
                
                html += '<tr>';
                html += `<td><strong>${order.workOrder}</strong></td>`;
                html += `<td>${order.customer || 'N/A'}</td>`;
                html += `<td>${order.lineNumber || 'N/A'}</td>`;
                html += `<td>${order.productType || 'N/A'}</td>`;
                html += `<td><span style="background: ${statusColor}; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: bold;">${status}</span></td>`;
                html += `<td>${skidsProduced} / ${skidsRequested}</td>`;
                html += `<td>${poundsRequested.toFixed(0)}</td>`;
                html += `<td><strong>${poundsProduced.toFixed(2)}</strong></td>`;
                html += `<td style="color: #c62828;">${woScrap.toFixed(2)}</td>`;
                html += `<td style="color: #e65100;">${(woDowntime / 60).toFixed(1)}</td>`;
                html += `<td>`;
                html += `<div style="display: flex; align-items: center; gap: 8px;">`;
                html += `<div style="flex: 1; background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">`;
                html += `<div style="width: ${Math.min(progressPct, 100)}%; height: 100%; background: ${progressPct >= 100 ? '#2e7d32' : '#f57c00'}; transition: width 0.3s;"></div>`;
                html += `</div>`;
                html += `<span style="font-size: 0.85em; font-weight: bold; min-width: 45px;">${progressPct}%</span>`;
                html += `</div>`;
                html += `</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            dashDiv.innerHTML = html;
            
            if (sortedDates.length > 0) {
                updateShiftBreakdown();
            }
            
            // Initialize table with default sort
            sortWorkOrders('workOrder');
        }

        // ==================== FIXED: SHIFT BREAKDOWN FUNCTIONS ====================
        function groupByShifts() {
            const shiftData = {};
            
            function initDay(dateKey) {
                if (!shiftData[dateKey]) {
                    shiftData[dateKey] = {
                        shift1: { 
                            skids: 0, netWeight: 0, rolls: 0, sheets: 0, rollWeight: 0, rollLength: 0, scrap: 0, downtime: 0,
                            lines: {
                                'Line 2': { skids: 0, netWeight: 0, rolls: 0, sheets: 0, rollWeight: 0, rollLength: 0, scrap: 0, downtime: 0 },
                                'Line 3': { skids: 0, netWeight: 0, rolls: 0, sheets: 0, rollWeight: 0, rollLength: 0, scrap: 0, downtime: 0 },
                                'Line 4': { skids: 0, netWeight: 0, rolls: 0, sheets: 0, rollWeight: 0, rollLength: 0, scrap: 0, downtime: 0 }
                            }
                        },
                        shift2: { 
                            skids: 0, netWeight: 0, rolls: 0, sheets: 0, rollWeight: 0, rollLength: 0, scrap: 0, downtime: 0,
                            lines: {
                                'Line 2': { skids: 0, netWeight: 0, rolls: 0, sheets: 0, rollWeight: 0, rollLength: 0, scrap: 0, downtime: 0 },
                                'Line 3': { skids: 0, netWeight: 0, rolls: 0, sheets: 0, rollWeight: 0, rollLength: 0, scrap: 0, downtime: 0 },
                                'Line 4': { skids: 0, netWeight: 0, rolls: 0, sheets: 0, rollWeight: 0, rollLength: 0, scrap: 0, downtime: 0 }
                            }
                        }
                    };
                }
            }
            
            productionData.forEach(prod => {
                const order = workOrders.find(o => o.workOrder === prod.workOrder);
                const lineNumber = order ? order.lineNumber : null;
                
                prod.skids.forEach(skid => {
                    const { dateKey, shift } = getShiftInfo(skid.timestamp);
                    initDay(dateKey);
                    
                    const shiftKey = shift === 1 ? 'shift1' : 'shift2';
                    shiftData[dateKey][shiftKey].skids++;
                    shiftData[dateKey][shiftKey].netWeight += parseFloat(skid.netWeight) || 0;
                    
                    if (lineNumber && shiftData[dateKey][shiftKey].lines[lineNumber]) {
                        shiftData[dateKey][shiftKey].lines[lineNumber].skids++;
                        shiftData[dateKey][shiftKey].lines[lineNumber].netWeight += parseFloat(skid.netWeight) || 0;
                    }
                    
                    if (skid.rolls && Array.isArray(skid.rolls)) {
                        skid.rolls.forEach(roll => {
                            shiftData[dateKey][shiftKey].rolls++;
                            shiftData[dateKey][shiftKey].rollWeight += parseFloat(roll.weight) || 0;
                            shiftData[dateKey][shiftKey].rollLength += parseFloat(roll.length || 0);
                            
                            if (lineNumber && shiftData[dateKey][shiftKey].lines[lineNumber]) {
                                shiftData[dateKey][shiftKey].lines[lineNumber].rolls++;
                                shiftData[dateKey][shiftKey].lines[lineNumber].rollWeight += parseFloat(roll.weight) || 0;
                                shiftData[dateKey][shiftKey].lines[lineNumber].rollLength += parseFloat(roll.length || 0);
                            }
                        });
                    }
                    
                    if (skid.sheetCount) {
                        shiftData[dateKey][shiftKey].sheets += parseInt(skid.sheetCount) || 0;
                        
                        if (lineNumber && shiftData[dateKey][shiftKey].lines[lineNumber]) {
                            shiftData[dateKey][shiftKey].lines[lineNumber].sheets += parseInt(skid.sheetCount) || 0;
                        }
                    }
                });
            });
            
            scrapData.forEach(scrap => {
                const { dateKey, shift } = getShiftInfo(scrap.timestamp);
                initDay(dateKey);
                
                const shiftKey = shift === 1 ? 'shift1' : 'shift2';
                shiftData[dateKey][shiftKey].scrap += parseFloat(scrap.weight) || 0;
                
                const order = workOrders.find(o => o.workOrder === scrap.workOrder);
                const lineNumber = order ? order.lineNumber : null;
                
                if (lineNumber && shiftData[dateKey][shiftKey].lines[lineNumber]) {
                    shiftData[dateKey][shiftKey].lines[lineNumber].scrap += parseFloat(scrap.weight) || 0;
                }
            });
            
            downtimeData.forEach(dt => {
                const { dateKey, shift } = getShiftInfo(dt.timestamp);
                initDay(dateKey);
                
                const shiftKey = shift === 1 ? 'shift1' : 'shift2';
                shiftData[dateKey][shiftKey].downtime += parseFloat(dt.duration) || 0;
                
                const order = workOrders.find(o => o.workOrder === dt.workOrder);
                const lineNumber = order ? order.lineNumber : null;
                
                if (lineNumber && shiftData[dateKey][shiftKey].lines[lineNumber]) {
                    shiftData[dateKey][shiftKey].lines[lineNumber].downtime += parseFloat(dt.duration) || 0;
                }
            });
            
            return shiftData;
        }
        
        function updateShiftBreakdown() {
            const selectedDate = document.getElementById('shiftDateSelector').value;
            const shiftData = groupByShifts();
            const dayData = shiftData[selectedDate];
            
            if (!dayData) {
                document.getElementById('shiftBreakdownContainer').innerHTML = '<div class="alert warning">No data recorded for this production day yet. Data will appear as production is entered.</div>';
                return;
            }
            
            const date = new Date(selectedDate + 'T12:00:00'); // Force noon to avoid timezone issues
            const dateStr = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Check if selected date is today
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const selectedDateObj = new Date(selectedDate + 'T12:00:00');
            selectedDateObj.setHours(0, 0, 0, 0);
            const isToday = selectedDateObj.getTime() === today.getTime();
            
            let html = `
                <div class="dashboard-card">
                    <h3 style="color: #212121; margin-bottom: 20px;">${dateStr} Production Day${isToday ? ' <span style="background: #2e7d32; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75em; margin-left: 10px;">TODAY</span>' : ''}</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="border: 2px solid #C00000; border-radius: 8px; padding: 15px; background: #fafafa;">
                            <h4 style="color: #C00000; margin-bottom: 15px;">1st Shift (6AM - 6PM)</h4>
                            <div class="mini-stat" style="margin: 8px 0;"><strong>Skids:</strong> ${dayData.shift1.skids}</div>
                            <div class="mini-stat" style="margin: 8px 0;"><strong>Net:</strong> ${dayData.shift1.netWeight.toFixed(2)} lbs</div>
                            ${dayData.shift1.rolls > 0 ? `<div class="mini-stat" style="margin: 8px 0;"><strong>Rolls:</strong> ${dayData.shift1.rolls}</div>` : ''}
                            ${dayData.shift1.sheets > 0 ? `<div class="mini-stat" style="margin: 8px 0;"><strong>Sheets:</strong> ${dayData.shift1.sheets}</div>` : ''}
                            <div class="mini-stat" style="margin: 8px 0; background: #ffebee;"><strong>Scrap:</strong> ${dayData.shift1.scrap.toFixed(2)} lbs</div>
                            <div class="mini-stat" style="margin: 8px 0; background: #fff3e0;"><strong>Downtime:</strong> ${(dayData.shift1.downtime / 60).toFixed(1)} hrs</div>
                            
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                                <h5 style="color: #C00000; margin-bottom: 10px; font-size: 0.9em;">By Line:</h5>
                                ${['Line 2', 'Line 3', 'Line 4'].map(line => {
                                    const ld = dayData.shift1.lines[line];
                                    return `<div style="background: white; padding: 8px; border-radius: 4px; margin: 5px 0; border-left: 3px solid #C00000;">
                                        <div style="font-weight: bold; font-size: 0.85em;">${line}</div>
                                        <div style="font-size: 0.75em;">Skids: ${ld.skids} | Net: ${ld.netWeight.toFixed(0)} lbs | Scrap: ${ld.scrap.toFixed(1)} lbs | Downtime: ${(ld.downtime / 60).toFixed(1)} hrs</div>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                        
                        <div style="border: 2px solid #424242; border-radius: 8px; padding: 15px; background: #fafafa;">
                            <h4 style="color: #424242; margin-bottom: 15px;">2nd Shift (6PM - 6AM)</h4>
                            <div class="mini-stat" style="margin: 8px 0;"><strong>Skids:</strong> ${dayData.shift2.skids}</div>
                            <div class="mini-stat" style="margin: 8px 0;"><strong>Net:</strong> ${dayData.shift2.netWeight.toFixed(2)} lbs</div>
                            ${dayData.shift2.rolls > 0 ? `<div class="mini-stat" style="margin: 8px 0;"><strong>Rolls:</strong> ${dayData.shift2.rolls}</div>` : ''}
                            ${dayData.shift2.sheets > 0 ? `<div class="mini-stat" style="margin: 8px 0;"><strong>Sheets:</strong> ${dayData.shift2.sheets}</div>` : ''}
                            <div class="mini-stat" style="margin: 8px 0; background: #ffebee;"><strong>Scrap:</strong> ${dayData.shift2.scrap.toFixed(2)} lbs</div>
                            <div class="mini-stat" style="margin: 8px 0; background: #fff3e0;"><strong>Downtime:</strong> ${(dayData.shift2.downtime / 60).toFixed(1)} hrs</div>
                            
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                                <h5 style="color: #424242; margin-bottom: 10px; font-size: 0.9em;">By Line:</h5>
                                ${['Line 2', 'Line 3', 'Line 4'].map(line => {
                                    const ld = dayData.shift2.lines[line];
                                    return `<div style="background: white; padding: 8px; border-radius: 4px; margin: 5px 0; border-left: 3px solid #424242;">
                                        <div style="font-weight: bold; font-size: 0.85em;">${line}</div>
                                        <div style="font-size: 0.75em;">Skids: ${ld.skids} | Net: ${ld.netWeight.toFixed(0)} lbs | Scrap: ${ld.scrap.toFixed(1)} lbs | Downtime: ${(ld.downtime / 60).toFixed(1)} hrs</div>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 5px;">
                        <strong>Daily Total:</strong>
                        Skids: ${dayData.shift1.skids + dayData.shift2.skids} | 
                        Production: ${(dayData.shift1.netWeight + dayData.shift2.netWeight).toFixed(2)} lbs | 
                        Scrap: ${(dayData.shift1.scrap + dayData.shift2.scrap).toFixed(2)} lbs | 
                        Downtime: ${((dayData.shift1.downtime + dayData.shift2.downtime) / 60).toFixed(1)} hrs
                    </div>
                </div>
            `;
            
            document.getElementById('shiftBreakdownContainer').innerHTML = html;
        }

        // ==================== SORTING FUNCTIONS ====================
        function sortWorkOrders(column) {
            // Toggle direction if clicking same column
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }
            
            // Create array with all order data for sorting
            const orderData = [];
            
            workOrders.forEach(order => {
                const prod = productionData.find(p => p.workOrder === order.workOrder);
                const skidsRequested = parseInt(order.skidsRequested) || 0;
                const poundsRequested = parseFloat(order.totalPoundsRequested) || 0;
                
                let status = 'Not Started';
                let statusPriority = 3;
                let skidsProduced = 0;
                let poundsProduced = 0;
                
                if (prod) {
                    skidsProduced = prod.skids.length;
                    prod.skids.forEach(skid => {
                        poundsProduced += parseFloat(skid.netWeight) || 0;
                    });
                    
                    if (prod.completed) {
                        status = 'Completed';
                        statusPriority = 1;
                    } else {
                        status = 'In Progress';
                        statusPriority = 2;
                    }
                }
                
                const woScrap = scrapData
                    .filter(s => s.workOrder === order.workOrder)
                    .reduce((sum, s) => sum + parseFloat(s.weight || 0), 0);
                
                const woDowntime = downtimeData
                    .filter(d => d.workOrder === order.workOrder)
                    .reduce((sum, d) => sum + parseFloat(d.duration || 0), 0);
                
                let progressPct = 0;
                if (poundsRequested > 0) {
                    progressPct = (poundsProduced / poundsRequested * 100);
                } else if (skidsRequested > 0) {
                    progressPct = (skidsProduced / skidsRequested * 100);
                }
                
                orderData.push({
                    order: order,
                    status: status,
                    statusPriority: statusPriority,
                    skidsProduced: skidsProduced,
                    skidsRequested: skidsRequested,
                    poundsRequested: poundsRequested,
                    poundsProduced: poundsProduced,
                    scrap: woScrap,
                    downtime: woDowntime,
                    progress: progressPct
                });
            });
            
            // Sort the data
            orderData.sort((a, b) => {
                let aVal, bVal;
                
                switch(column) {
                    case 'workOrder':
                        aVal = a.order.workOrder || '';
                        bVal = b.order.workOrder || '';
                        break;
                    case 'customer':
                        aVal = a.order.customer || '';
                        bVal = b.order.customer || '';
                        break;
                    case 'line':
                        aVal = a.order.lineNumber || '';
                        bVal = b.order.lineNumber || '';
                        break;
                    case 'productType':
                        aVal = a.order.productType || '';
                        bVal = b.order.productType || '';
                        break;
                    case 'status':
                        aVal = a.statusPriority;
                        bVal = b.statusPriority;
                        break;
                    case 'skids':
                        aVal = a.skidsProduced;
                        bVal = b.skidsProduced;
                        break;
                    case 'requested':
                        aVal = a.poundsRequested;
                        bVal = b.poundsRequested;
                        break;
                    case 'produced':
                        aVal = a.poundsProduced;
                        bVal = b.poundsProduced;
                        break;
                    case 'scrap':
                        aVal = a.scrap;
                        bVal = b.scrap;
                        break;
                    case 'downtime':
                        aVal = a.downtime;
                        bVal = b.downtime;
                        break;
                    case 'progress':
                        aVal = a.progress;
                        bVal = b.progress;
                        break;
                    case 'dueDate':
                        aVal = a.order.dueDate || '';
                        bVal = b.order.dueDate || '';
                        break;
                    default:
                        aVal = a.order.workOrder || '';
                        bVal = b.order.workOrder || '';
                }
                
                // Handle string vs number comparison
                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                    if (currentSortDirection === 'asc') {
                        return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                    } else {
                        return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                    }
                } else {
                    if (currentSortDirection === 'asc') {
                        return aVal - bVal;
                    } else {
                        return bVal - aVal;
                    }
                }
            });
            
            // Rebuild the table with sorted data
            rebuildWorkOrderTable(orderData);
            
            // Update sort indicator
            updateSortIndicators(column);
        }
        
        function rebuildWorkOrderTable(sortedData) {
            const tbody = document.getElementById('workOrderProgressBody');
            if (!tbody) return;
            
            let html = '';
            
            sortedData.forEach(data => {
                const order = data.order;
                let statusColor = '#ffebee';
                if (data.status === 'Completed') statusColor = '#e8f5e9';
                if (data.status === 'In Progress') statusColor = '#fff3e0';
                
                html += '<tr>';
                html += `<td><strong>${order.workOrder}</strong></td>`;
                html += `<td>${order.customer || 'N/A'}</td>`;
                html += `<td>${order.lineNumber || 'N/A'}</td>`;
                html += `<td>${order.productType || 'N/A'}</td>`;
                html += `<td><span style="background: ${statusColor}; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: bold;">${data.status}</span></td>`;
                html += `<td>${data.skidsProduced} / ${data.skidsRequested}</td>`;
                html += `<td>${data.poundsRequested.toFixed(0)}</td>`;
                html += `<td><strong>${data.poundsProduced.toFixed(2)}</strong></td>`;
                html += `<td style="color: #c62828;">${data.scrap.toFixed(2)}</td>`;
                html += `<td style="color: #e65100;">${(data.downtime / 60).toFixed(1)}</td>`;
                html += `<td>`;
                html += `<div style="display: flex; align-items: center; gap: 8px;">`;
                html += `<div style="flex: 1; background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">`;
                html += `<div style="width: ${Math.min(data.progress, 100)}%; height: 100%; background: ${data.progress >= 100 ? '#2e7d32' : '#f57c00'}; transition: width 0.3s;"></div>`;
                html += `</div>`;
                html += `<span style="font-size: 0.85em; font-weight: bold; min-width: 45px;">${data.progress.toFixed(1)}%</span>`;
                html += `</div>`;
                html += `</td>`;
                html += '</tr>';
            });
            
            tbody.innerHTML = html;
        }
        
        function updateSortIndicators(activeColumn) {
            // Update all sort indicators
            const headers = document.querySelectorAll('.sortable-header');
            headers.forEach(header => {
                const indicator = header.querySelector('.sort-indicator');
                if (indicator) {
                    indicator.classList.remove('active');
                    indicator.textContent = '‚áÖ';
                }
            });
            
            // Update active column indicator
            const activeHeaders = document.querySelectorAll('.sortable-header');
            activeHeaders.forEach(header => {
                const onclick = header.getAttribute('onclick');
                if (onclick && onclick.includes(`'${activeColumn}'`)) {
                    const indicator = header.querySelector('.sort-indicator');
                    if (indicator) {
                        indicator.classList.add('active');
                        indicator.textContent = currentSortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
                    }
                }
            });
            
            // Update button styles
            const buttons = document.querySelectorAll('.sort-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                const onclick = btn.getAttribute('onclick');
                if (onclick && onclick.includes(`'${activeColumn}'`)) {
                    btn.classList.add('active');
                }
            });
        }

        // ==================== EXPORT & PRINT FUNCTIONS (UPDATED WITH OPERATOR NAME) ====================
        function exportAllData() {
            let csv = 'DATA EXPORT - ' + getESTTimestamp() + '\n\n';
            
            csv += 'WORK ORDERS\n';
            csv += 'Order Date,Due Date,Work Order #,Line Number,Item Number,Customer,Customer PO,Product Type,Color,Material,Length (in),Width,Gauge,Finish,Skids Requested,Total Pounds Requested,Sheets Requested,Rolls Requested,Special Instructions\n';
            workOrders.forEach(order => {
                const instructions = order.specialInstructions ? order.specialInstructions.replace(/"/g, '""') : '';
                csv += `${order.orderDate},${order.dueDate},${order.workOrder},${order.lineNumber},${order.itemNumber},${order.customer},${order.customerPO},${order.productType || ''},${order.color},${order.material},${order.length},${order.width},${order.gauge},${order.finish},${order.skidsRequested},${order.totalPoundsRequested},${order.sheetsRequested},${order.rollsRequested},"${instructions}"\n`;
            });
            
            csv += '\n\nPRODUCTION DATA\n';
            csv += 'Work Order,Customer,Item Number,Start Time (EST),Started By,End Time (EST),Completed,Total Skids,Total Net Weight\n';
            productionData.forEach(prod => {
                const totalNet = prod.skids.reduce((sum, s) => sum + parseFloat(s.netWeight || 0), 0);
                csv += `${prod.workOrder},${prod.customer},${prod.itemNumber},${parseTimestampToEST(prod.startTime)},${prod.startedBy || 'N/A'},${prod.endTime ? parseTimestampToEST(prod.endTime) : 'In Progress'},${prod.completed},${prod.skids.length},${totalNet.toFixed(2)}\n`;
            });
            
            csv += '\n\nSKID DETAILS\n';
            csv += 'Work Order,Skid Number,Operator,Gross Weight,Net Weight,Sheet Count,Roll Count,Timestamp (EST)\n';
            productionData.forEach(prod => {
                prod.skids.forEach((skid, idx) => {
                    const rollCount = skid.rolls ? skid.rolls.length : 0;
                    csv += `${prod.workOrder},${idx + 1},${skid.operator || 'N/A'},${skid.grossWeight},${skid.netWeight},${skid.sheetCount || ''},${rollCount || ''},${parseTimestampToEST(skid.timestamp)}\n`;
                });
            });
            
            csv += '\n\nROLL DETAILS\n';
            csv += 'Work Order,Skid Number,Roll Number,Weight (lbs),Length (ft)\n';
            productionData.forEach(prod => {
                prod.skids.forEach((skid, skidIdx) => {
                    if (skid.rolls && Array.isArray(skid.rolls)) {
                        skid.rolls.forEach((roll, rollIdx) => {
                            csv += `${prod.workOrder},${skidIdx + 1},${rollIdx + 1},${roll.weight},${roll.length || ''}\n`;
                        });
                    }
                });
            });
            
            csv += '\n\nDOWNTIME DATA\n';
            csv += 'Work Order,Type,Duration (min),Reason,Timestamp (EST)\n';
            downtimeData.forEach(dt => {
                csv += `${dt.workOrder},${dt.type},${dt.duration},${dt.reason},${parseTimestampToEST(dt.timestamp)}\n`;
            });
            
	    csv += '\n\nSCRAP DATA\n';
	    csv += 'Work Order,Type,Weight (lbs),Reason,Operator,Timestamp (EST)\n';
	    scrapData.forEach(scrap => {
	                const reason = (scrap.reason || '').replace(/"/g, '""'); // Escape quotes
	                const type = (scrap.type || '').replace(/"/g, '""');
	                const operator = (scrap.operator || 'N/A').replace(/"/g, '""');
	                csv += `${scrap.workOrder},"${type}",${scrap.weight},"${reason}","${operator}",${parseTimestampToEST(scrap.timestamp)}\n`;
	    });            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Production_Report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function printProductionReport(woNumber) {
    const production = productionData.find(p => p.workOrder === woNumber);
    const order = workOrders.find(o => o.workOrder === woNumber);
    
    if (!production || !order) {
        alert('Production or work order not found');
        return;
    }
    
    // Calculate totals
    const totalGross = production.skids.reduce((sum, s) => sum + parseFloat(s.grossWeight || 0), 0);
    const totalNet = production.skids.reduce((sum, s) => sum + parseFloat(s.netWeight || 0), 0);
    const totalScrap = scrapData
        .filter(s => s.workOrder === woNumber)
        .reduce((sum, s) => sum + parseFloat(s.weight || 0), 0);
    const totalDowntime = downtimeData
        .filter(d => d.workOrder === woNumber)
        .reduce((sum, d) => sum + parseFloat(d.duration || 0), 0);
    
    let totalRolls = 0;
    let totalSheets = 0;
    let totalRollWeight = 0;
    let totalRollLength = 0;
    
    const isRolls = order.productType === 'Rolls';
    const isSheets = order.productType === 'Sheets';
    
    if (isRolls) {
        production.skids.forEach(skid => {
            if (skid.rolls && Array.isArray(skid.rolls)) {
                totalRolls += skid.rolls.length;
                skid.rolls.forEach(roll => {
                    totalRollWeight += parseFloat(roll.weight || 0);
                    totalRollLength += parseFloat(roll.length || 0);
                });
            }
        });
    } else if (isSheets) {
        totalSheets = production.skids.reduce((sum, s) => sum + parseInt(s.sheetCount || 0), 0);
    }
    
    // Generate HTML for printing
    const printWindow = window.open('', '', 'width=800,height=600');
    
    let reportHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Production Report - ${woNumber}</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    padding: 20px;
                    color: #000;
                }
                h1 {
                    color: #C00000;
                    border-bottom: 3px solid #C00000;
                    padding-bottom: 10px;
                }
                h2 {
                    color: #424242;
                    margin-top: 25px;
                    border-bottom: 2px solid #e0e0e0;
                    padding-bottom: 8px;
                }
                .header-info {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                    margin: 20px 0;
                    font-size: 14px;
                }
                .header-info div {
                    padding: 8px;
                    background: #f5f5f5;
                    border-left: 3px solid #C00000;
                }
                .summary-stats {
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 15px;
                    margin: 20px 0;
                }
                .stat-box {
                    border: 2px solid #e0e0e0;
                    padding: 15px;
                    text-align: center;
                    background: #fafafa;
                }
                .stat-box .label {
                    font-size: 12px;
                    color: #757575;
                    margin-bottom: 5px;
                }
                .stat-box .value {
                    font-size: 24px;
                    font-weight: bold;
                    color: #C00000;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 15px 0;
                }
                th {
                    background: #C00000;
                    color: white;
                    padding: 10px;
                    text-align: left;
                    font-size: 13px;
                }
                td {
                    padding: 8px;
                    border-bottom: 1px solid #e0e0e0;
                    font-size: 12px;
                }
                tr:nth-child(even) {
                    background: #f9f9f9;
                }
                .footer {
                    margin-top: 30px;
                    padding-top: 15px;
                    border-top: 2px solid #C00000;
                    font-size: 11px;
                    color: #757575;
                }
                @media print {
                    body { padding: 10px; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <h1>GRIMCO MANUFACTURING - PRODUCTION REPORT</h1>
            
            <div class="header-info">
                <div><strong>Work Order:</strong> ${order.workOrder}</div>
                <div><strong>Line:</strong> ${order.lineNumber || 'N/A'}</div>
                <div><strong>Customer:</strong> ${order.customer || 'N/A'}</div>
                <div><strong>Customer PO:</strong> ${order.customerPO || 'N/A'}</div>
                <div><strong>Item Number:</strong> ${order.itemNumber || 'N/A'}</div>
                <div><strong>Product Type:</strong> ${order.productType || 'N/A'}</div>
                <div><strong>Material:</strong> ${order.material || 'N/A'}</div>
                <div><strong>Color:</strong> ${order.color || 'N/A'}</div>
                <div><strong>Gauge:</strong> ${order.gauge || 'N/A'}</div>
                <div><strong>Width:</strong> ${order.width || 'N/A'}</div>
                <div><strong>Length:</strong> ${order.length || 'N/A'}"</div>
                <div><strong>Finish:</strong> ${order.finish || 'N/A'}</div>
                <div><strong>Start Time:</strong> ${parseTimestampToEST(production.startTime)}</div>
                <div><strong>Started By:</strong> ${production.startedBy || 'N/A'}</div>
                ${production.completed ? `
                    <div><strong>End Time:</strong> ${parseTimestampToEST(production.endTime)}</div>
                    <div><strong>Status:</strong> COMPLETED</div>
                ` : '<div colspan="2"><strong>Status:</strong> IN PROGRESS</div>'}
            </div>
            
            <h2>Production Summary</h2>
            <div class="summary-stats">
                <div class="stat-box">
                    <div class="label">Total Skids</div>
                    <div class="value">${production.skids.length}</div>
                </div>
                <div class="stat-box">
                    <div class="label">Gross Weight</div>
                    <div class="value">${totalGross.toFixed(2)} lbs</div>
                </div>
                <div class="stat-box">
                    <div class="label">Net Weight</div>
                    <div class="value">${totalNet.toFixed(2)} lbs</div>
                </div>
                <div class="stat-box">
                    <div class="label">Total Scrap</div>
                    <div class="value">${totalScrap.toFixed(2)} lbs</div>
                </div>
            </div>
    `;
    
    if (isRolls) {
        reportHTML += `
            <div class="summary-stats">
                <div class="stat-box">
                    <div class="label">Total Rolls</div>
                    <div class="value">${totalRolls}</div>
                </div>
                <div class="stat-box">
                    <div class="label">Roll Weight</div>
                    <div class="value">${totalRollWeight.toFixed(2)} lbs</div>
                </div>
                <div class="stat-box">
                    <div class="label">Roll Length</div>
                    <div class="value">${totalRollLength.toFixed(0)} ft</div>
                </div>
                <div class="stat-box">
                    <div class="label">Downtime</div>
                    <div class="value">${(totalDowntime / 60).toFixed(1)} hrs</div>
                </div>
            </div>
        `;
    } else if (isSheets) {
        reportHTML += `
            <div class="summary-stats" style="grid-template-columns: repeat(2, 1fr);">
                <div class="stat-box">
                    <div class="label">Total Sheets</div>
                    <div class="value">${totalSheets}</div>
                </div>
                <div class="stat-box">
                    <div class="label">Downtime</div>
                    <div class="value">${(totalDowntime / 60).toFixed(1)} hrs</div>
                </div>
            </div>
        `;
    }
    
    reportHTML += `<h2>Skid Details</h2><table><thead><tr>
        <th>Skid #</th>
        <th>Operator</th>
        <th>Gross (lbs)</th>
        <th>Net (lbs)</th>
        ${isRolls ? '<th>Rolls</th>' : ''}
        ${isSheets ? '<th>Sheets</th>' : ''}
        <th>Timestamp (EST)</th>
    </tr></thead><tbody>`;
    
    production.skids.forEach((skid, idx) => {
        reportHTML += `<tr>
            <td>${idx + 1}</td>
            <td>${skid.operator || 'N/A'}</td>
            <td>${skid.grossWeight}</td>
            <td>${skid.netWeight}</td>
            ${isRolls ? `<td>${skid.rolls ? skid.rolls.length : 0}</td>` : ''}
            ${isSheets ? `<td>${skid.sheetCount || 0}</td>` : ''}
            <td>${parseTimestampToEST(skid.timestamp)}</td>
        </tr>`;
    });
    
    reportHTML += '</tbody></table>';
    
    if (isRolls) {
        reportHTML += '<h2>Roll Details</h2><table><thead><tr><th>Skid #</th><th>Roll #</th><th>Weight (lbs)</th><th>Length (ft)</th></tr></thead><tbody>';
        
        production.skids.forEach((skid, skidIdx) => {
            if (skid.rolls && Array.isArray(skid.rolls)) {
                skid.rolls.forEach((roll, rollIdx) => {
                    reportHTML += `<tr>
                        <td>${skidIdx + 1}</td>
                        <td>${rollIdx + 1}</td>
                        <td>${roll.weight}</td>
                        <td>${roll.length || 'N/A'}</td>
                    </tr>`;
                });
            }
        });
        
        reportHTML += '</tbody></table>';
    }
    
    // Add scrap data if any
	const woScrap = scrapData.filter(s => s.workOrder === woNumber);
	if (woScrap.length > 0) {
	    reportHTML += '<h2>Scrap Records</h2><table><thead><tr><th>Type</th><th>Weight (lbs)</th><th>Reason</th><th>Operator</th><th>Timestamp (EST)</th></tr>	</thead><tbody>';
    
	    woScrap.forEach(scrap => {
	        reportHTML += `<tr>
	            <td>${scrap.type}</td>
	            <td>${scrap.weight.toFixed(2)}</td>
	            <td>${scrap.reason}</td>
	            <td>${scrap.operator || 'N/A'}</td>
	            <td>${parseTimestampToEST(scrap.timestamp)}</td>
	        </tr>`;
	    });
    
    reportHTML += '</tbody></table>';
}    
    // Add downtime data if any
    const woDowntime = downtimeData.filter(d => d.workOrder === woNumber);
    if (woDowntime.length > 0) {
        reportHTML += '<h2>Downtime Records</h2><table><thead><tr><th>Type</th><th>Duration (min)</th><th>Reason</th><th>Timestamp (EST)</th></tr></thead><tbody>';
        
        woDowntime.forEach(dt => {
            reportHTML += `<tr>
                <td>${dt.type}</td>
                <td>${dt.duration}</td>
                <td>${dt.reason}</td>
                <td>${parseTimestampToEST(dt.timestamp)}</td>
            </tr>`;
        });
        
        reportHTML += '</tbody></table>';
    }
    
    reportHTML += `
            <div class="footer">
                Report generated: ${getESTTimestamp()}<br>
                GRIMCO Manufacturing - HIPS Extrusion Operations
            </div>
            
            <div class="no-print" style="margin-top: 20px; text-align: center;">
                <button onclick="window.print()" style="background: #C00000; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Print Report</button>
                <button onclick="window.close()" style="background: #757575; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-left: 10px;">Close</button>
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(reportHTML);
    printWindow.document.close();
}

function printSkidLabel(woNumber, skidIndex) {
    const production = productionData.find(p => p.workOrder === woNumber);
    const order = workOrders.find(o => o.workOrder === woNumber);
    
    if (!production || !order) {
        alert('Production or work order not found');
        return;
    }
    
    const skid = production.skids[skidIndex];
    if (!skid) {
        alert('Skid not found');
        return;
    }
    
    const isRolls = order.productType === 'Rolls';
    const skidNum = skidIndex + 1;
    
    const printWindow = window.open('', '', 'width=850,height=1100');
    
    let labelHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Skid Label - ${woNumber} #${skidNum}</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { 
                    font-family: Arial, sans-serif;
                    background: #f0f0f0;
                    padding: 20px;
                }
                .skid-label {
                    width: 8.5in;
                    height: 11in;
                    margin: 0 auto;
                    padding: 0.4in;
                    background: white;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                }
                .label-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    border-bottom: 4px solid #C00000;
                    padding-bottom: 15px;
                    margin-bottom: 20px;
                }
                .label-company-name {
                    font-size: 36px;
                    font-weight: bold;
                    color: #C00000;
                    margin-bottom: 5px;
                    font-family: Arial Black, Arial, sans-serif;
                    letter-spacing: 2px;
                }
                .label-subtitle {
                    font-size: 11px;
                    font-weight: bold;
                    margin-bottom: 8px;
                }
                .label-contact {
                    font-size: 10px;
                    color: #333;
                }
                .label-header-right {
                    border: 3px solid #2e7d32;
                    width: 180px;
                    height: 80px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: white;
                }
                .label-barcode-placeholder {
                    text-align: center;
                    color: #757575;
                    font-size: 10px;
                }
                .label-info-row {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 15px;
                    margin: 15px 0;
                }
                .label-field {
                    display: flex;
                    align-items: baseline;
                    font-size: 11px;
                    border-bottom: 2px solid #000;
                    padding-bottom: 3px;
                }
                .label-field-name {
                    font-weight: bold;
                    min-width: 85px;
                    color: #424242;
                }
                .label-field-value {
                    flex: 1;
                    font-size: 12px;
                    padding-left: 5px;
                }
                .label-wo-number {
                    font-size: 72px;
                    font-weight: bold;
                    text-align: center;
                    margin: 20px 0;
                    font-family: Arial Black, Arial, sans-serif;
                    color: #C00000;
                    line-height: 1;
                }
                .label-description-box {
                    border: 3px solid #000;
                    padding: 15px;
                    margin: 20px 0;
                    background: #fafafa;
                }
                .label-description-title {
                    font-weight: bold;
                    font-size: 10px;
                    color: #C00000;
                    margin-bottom: 8px;
                    letter-spacing: 1px;
                }
                .label-description-text {
                    font-size: 18px;
                    font-weight: bold;
                    text-align: center;
                    color: #000;
                }
                .label-weights-section {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 20px;
                    margin: 20px 0;
                }
                .label-weight-box {
                    border: 2px solid #000;
                    padding: 12px;
                    background: white;
                }
                .label-weight-label {
                    font-size: 11px;
                    font-weight: bold;
                    color: #424242;
                    margin-bottom: 5px;
                }
                .label-weight-value {
                    font-size: 24px;
                    font-weight: bold;
                    color: #000;
                }
                .label-rolls-section {
                    margin: 15px 0;
                    border: 2px solid #C00000;
                    padding: 12px;
                    background: #fff;
                    max-height: 200px;
                    overflow-y: auto;
                }
                .label-rolls-title {
                    font-weight: bold;
                    font-size: 11px;
                    color: #C00000;
                    margin-bottom: 8px;
                    text-transform: uppercase;
                }
                .label-roll-item {
                    padding: 4px 0;
                    border-bottom: 1px solid #e0e0e0;
                    font-size: 10px;
                }
                .label-roll-item:last-child {
                    border-bottom: none;
                }
                .no-print {
                    text-align: center;
                    margin-top: 20px;
                }
                @media print {
                    body { background: white; padding: 0; }
                    .skid-label { 
                        width: 8.5in;
                        height: 11in;
                        margin: 0;
                        padding: 0.4in;
                        box-shadow: none;
                    }
                    .no-print { display: none; }
                    @page {
                        size: 8.5in 11in portrait;
                        margin: 0;
                    }
                }
            </style>
        </head>
        <body>
            <div class="skid-label">
                <div class="label-header">
                    <div class="label-header-left">
                        <div class="label-company-name">${systemSettings.companyName}</div>
                        <div class="label-subtitle">${systemSettings.subtitle}</div>
                        <div class="label-contact">
                            ${systemSettings.phone} | ${systemSettings.email}
                        </div>
                    </div>
                    ${systemSettings.showBarcode ? `
                    <div class="label-header-right">
                        <div class="label-barcode-placeholder">
                            BARCODE<br>${woNumber}
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <div class="label-wo-number">${woNumber}</div>
                
                <div class="label-info-row">
                    <div class="label-field">
                        <span class="label-field-name">SKID #:</span>
                        <span class="label-field-value">${skidNum}</span>
                    </div>
                    <div class="label-field">
                        <span class="label-field-name">OPERATOR:</span>
                        <span class="label-field-value">${skid.operator || 'N/A'}</span>
                    </div>
                </div>
                
                <div class="label-info-row">
                    <div class="label-field">
                        <span class="label-field-name">CUSTOMER:</span>
                        <span class="label-field-value">${order.customer || 'N/A'}</span>
                    </div>
                    <div class="label-field">
                        <span class="label-field-name">ITEM #:</span>
                        <span class="label-field-value">${order.itemNumber || 'N/A'}</span>
                    </div>
                </div>
                
                <div class="label-info-row">
                    <div class="label-field">
                        <span class="label-field-name">LINE:</span>
                        <span class="label-field-value">${order.lineNumber || 'N/A'}</span>
                    </div>
                    <div class="label-field">
                        <span class="label-field-name">DATE:</span>
                        <span class="label-field-value">${parseTimestampToEST(skid.timestamp).split(',')[0]}</span>
                    </div>
                </div>
                
                <div class="label-description-box">
                    <div class="label-description-title">PRODUCT DESCRIPTION</div>
                    <div class="label-description-text">
                        ${order.productType || 'N/A'} | ${order.color || 'N/A'} | ${order.gauge || 'N/A'} | ${order.width || 'N/A'} x ${order.length || 'N/A'}"
                    </div>
                </div>
                
                <div class="label-weights-section">
                    <div class="label-weight-box">
                        <div class="label-weight-label">GROSS WEIGHT</div>
                        <div class="label-weight-value">${skid.grossWeight} lbs</div>
                    </div>
                    <div class="label-weight-box">
                        <div class="label-weight-label">NET WEIGHT</div>
                        <div class="label-weight-value">${skid.netWeight} lbs</div>
                    </div>
                </div>
    `;
    
    if (isRolls && skid.rolls && skid.rolls.length > 0 && systemSettings.showRollDetails) {
        labelHTML += `
                <div class="label-rolls-section">
                    <div class="label-rolls-title">ROLL DETAILS (${skid.rolls.length} Rolls)</div>
        `;
        
        skid.rolls.forEach((roll, idx) => {
            const lengthText = roll.length ? ` | ${roll.length} ft` : '';
            labelHTML += `
                    <div class="label-roll-item">
                        <strong>Roll ${idx + 1}:</strong> ${roll.weight} lbs${lengthText}
                    </div>
            `;
        });
        
        labelHTML += '</div>';
    } else if (!isRolls && skid.sheetCount) {
        labelHTML += `
                <div class="label-rolls-section">
                    <div class="label-rolls-title">SHEET COUNT</div>
                    <div style="font-size: 28px; font-weight: bold; text-align: center; margin: 10px 0;">${skid.sheetCount} Sheets</div>
                </div>
        `;
    }
    
    labelHTML += `
            </div>
            
            <div class="no-print">
                <button onclick="window.print()" style="background: #C00000; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px;">Print Label</button>
                <button onclick="window.close()" style="background: #757575; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px;">Close</button>
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(labelHTML);
    printWindow.document.close();
}
	// Super Simplified Production Report Export Function
// Only exports Day Totals and Shift Totals - no line breakdowns, no statistics

function exportSimplifiedProductionReport() {
    // Get data from localStorage (exactly as in your original tool)
    const productionData = JSON.parse(localStorage.getItem('productionData') || '[]');
    const downtimeData = JSON.parse(localStorage.getItem('downtimeData') || '[]');
    const scrapData = JSON.parse(localStorage.getItem('scrapData') || '[]');
    const workOrders = JSON.parse(localStorage.getItem('workOrders') || '[]');
    
    // Check if there's any data to export
    if (productionData.length === 0 && downtimeData.length === 0 && scrapData.length === 0) {
        alert('No data available to export. Please enter some production data first.');
        return;
    }
    
    // Helper function to determine shift (1st: 6AM-6PM, 2nd: 6PM-6AM)
    function getShiftInfo(timestamp) {
        const date = new Date(timestamp);
        const hours = date.getHours();
        const shift = (hours >= 6 && hours < 18) ? 1 : 2;
        
        // Adjust date for 2nd shift (after midnight belongs to previous day)
        let prodDate = new Date(date);
        if (hours < 6) {
            prodDate.setDate(prodDate.getDate() - 1);
        }
        
        const dateKey = prodDate.toISOString().split('T')[0];
        return { dateKey, shift, date: prodDate };
    }
    
    // Initialize data structure
    const reportData = {};
    
    // Helper to initialize day/shift/line structure
    function initReportStructure(dateKey, shift, line) {
        if (!reportData[dateKey]) {
            reportData[dateKey] = {};
        }
        
        const shiftKey = shift === 1 ? '1st Shift (6AM-6PM)' : '2nd Shift (6PM-6AM)';
        
        if (!reportData[dateKey][shiftKey]) {
            reportData[dateKey][shiftKey] = {};
        }
        
        if (line && !reportData[dateKey][shiftKey][line]) {
            reportData[dateKey][shiftKey][line] = {
                pounds: 0,
                downtime: 0,
                scrap: 0
            };
        }
    }
    
    // Process production data (pounds produced)
    productionData.forEach(prod => {
        const order = workOrders.find(o => o.workOrder === prod.workOrder);
        const lineNumber = order ? order.lineNumber : 'Unknown';
        
        if (prod.skids && Array.isArray(prod.skids)) {
            prod.skids.forEach(skid => {
                const { dateKey, shift } = getShiftInfo(skid.timestamp);
                initReportStructure(dateKey, shift, lineNumber);
                
                const netWeight = parseFloat(skid.netWeight) || 0;
                const shiftKey = shift === 1 ? '1st Shift (6AM-6PM)' : '2nd Shift (6PM-6AM)';
                
                reportData[dateKey][shiftKey][lineNumber].pounds += netWeight;
            });
        }
    });
    
    // Process downtime data
    downtimeData.forEach(dt => {
        const order = workOrders.find(o => o.workOrder === dt.workOrder);
        const lineNumber = order ? order.lineNumber : 'Unknown';
        const { dateKey, shift } = getShiftInfo(dt.timestamp);
        
        initReportStructure(dateKey, shift, lineNumber);
        
        const duration = parseFloat(dt.duration) || 0;
        const shiftKey = shift === 1 ? '1st Shift (6AM-6PM)' : '2nd Shift (6PM-6AM)';
        
        reportData[dateKey][shiftKey][lineNumber].downtime += duration;
    });
    
    // Process scrap data
    scrapData.forEach(scrap => {
        const order = workOrders.find(o => o.workOrder === scrap.workOrder);
        const lineNumber = order ? order.lineNumber : 'Unknown';
        const { dateKey, shift } = getShiftInfo(scrap.timestamp);
        
        initReportStructure(dateKey, shift, lineNumber);
        
        const weight = parseFloat(scrap.weight) || 0;
        const shiftKey = shift === 1 ? '1st Shift (6AM-6PM)' : '2nd Shift (6PM-6AM)';
        
        reportData[dateKey][shiftKey][lineNumber].scrap += weight;
    });
    
    // Check if we have any data to report
    if (Object.keys(reportData).length === 0) {
        alert('No data found to export.');
        return;
    }
    
    // Generate CSV - Simple header
    let csv = 'SIMPLIFIED PRODUCTION REPORT\n';
    csv += `Generated: ${new Date().toLocaleString('en-US', { timeZone: 'America/New_York' })} EST\n`;
    csv += 'GRIMCO Manufacturing - HIPS Extrusion Operations\n\n';
    
    // Data header
    csv += 'Date,Shift,Line,Pounds Produced,Downtime (min),Scrap (lbs)\n';
    
    // Sort dates
    const sortedDates = Object.keys(reportData).sort();
    
    // Output data by date, shift, and line
    sortedDates.forEach(dateKey => {
        const dayData = reportData[dateKey];
        
        // Process each shift
        ['1st Shift (6AM-6PM)', '2nd Shift (6PM-6AM)'].forEach(shiftKey => {
            if (dayData[shiftKey]) {
                // Sort lines for consistent output
                const lines = Object.keys(dayData[shiftKey]).sort();
                
                lines.forEach(line => {
                    const lineData = dayData[shiftKey][line];
                    csv += `${dateKey},${shiftKey},${line},${lineData.pounds.toFixed(0)},${lineData.downtime.toFixed(0)},${lineData.scrap.toFixed(0)}\n`;
                });
            }
        });
    });
    
    // Download the CSV file
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    
    const filename = `Simplified_Production_Report_${new Date().toISOString().split('T')[0]}.csv`;
    link.download = filename;
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
    
    alert(`Report exported successfully as ${filename}`);
}
</script>
</body>
</html>